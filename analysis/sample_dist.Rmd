---
title: "sample_dist"
author: "Tina Lasisi"
date: "2025-07-03"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

```{r}
# Load required libraries
library(ggtree)
library(ggtreeExtra)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ape)
library(viridis)
library(ggnewscale)

# Read the tree and data
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")
```

## Match species

```{r match-species}
# === SPECIES OVERLAP ANALYSIS ===
cat("=== SPECIES OVERLAP ANALYSIS ===\n\n")

# Extract species names
tree_species <- gsub("_", " ", tree$tip.label)
data_species <- unique(data$species)

cat("Raw counts:\n")
cat("  Tree species:", length(tree_species), "\n")
cat("  Data species:", length(data_species), "\n\n")

# Create a list of ALL possible names for each species in the data
# This accounts for the mixed Callicebus/Plecturocebus naming
data_all_names <- data %>%
  select(species, inat_name, species_binom, key) %>%
  unique() %>%
  mutate(
    # Create a list of all possible names for matching
    all_names = paste(na.omit(c(species, inat_name, species_binom, key)), collapse = "|")
  )

# Function to check if a tree species matches any name variant in data
match_species <- function(tree_sp, data_names_df) {
  for (i in 1:nrow(data_names_df)) {
    # Check all name variants
    if (tree_sp == data_names_df$species[i] ||
        tree_sp == data_names_df$inat_name[i] ||
        tree_sp == data_names_df$species_binom[i] ||
        tree_sp == data_names_df$key[i]) {
      return(data_names_df$species[i])  # Return the primary species name
    }
  }
  
  # Check if species epithet matches with different genus (for Callicebus/Plecturocebus)
  tree_parts <- strsplit(tree_sp, " ")[[1]]
  if (length(tree_parts) == 2 && tree_parts[1] == "Callicebus") {
    tree_epithet <- tree_parts[2]
    for (i in 1:nrow(data_names_df)) {
      # Check if any Plecturocebus species has the same epithet
      if (!is.na(data_names_df$species[i]) && 
          grepl(paste0("Plecturocebus ", tree_epithet), data_names_df$species[i])) {
        return(data_names_df$species[i])
      }
    }
  }
  
  # Also check specific mappings
  if (tree_sp == "Trachypithecus johnii" && "Semnopithecus johnii" %in% data_names_df$species) {
    return("Semnopithecus johnii")
  }
  if (tree_sp == "Cercopithecus preussi" && "Allochrocebus preussi" %in% data_names_df$species) {
    return("Allochrocebus preussi")
  }
  if (tree_sp == "Oreonax flavicauda" && "Lagothrix flavicauda" %in% data_names_df$species) {
    return("Lagothrix flavicauda")
  }
  if (tree_sp == "Lagothrix lagotricha" && "Lagothrix lagothricha" %in% data_names_df$species) {
    return("Lagothrix lagothricha")
  }
  return(NA)
}

# Match tree species to data species
tree_matches <- sapply(tree_species, match_species, data_all_names)
matched_species <- unique(na.omit(tree_matches))
unmatched_tree <- tree_species[is.na(tree_matches)]
unmatched_data <- setdiff(data_species, matched_species)

# Calculate final numbers
in_both <- length(matched_species)
tree_only <- length(unmatched_tree)
data_only <- length(unmatched_data)

cat("After flexible name matching:\n")
cat("  Matched species:", in_both, "\n")
cat("  Only in tree:", tree_only, "\n")
cat("  Only in data:", data_only, "\n\n")

# Show matched species by type
matched_data <- data[data$species %in% matched_species, ]
cat("Matched species by type:\n")
type_counts <- table(matched_data$type)
for (type in names(type_counts)) {
  cat(sprintf("  %s: %d\n", type, type_counts[type]))
}

# List species only in data
if (data_only > 0) {
  cat("\nSpecies ONLY in data:\n")
  data_only_info <- data[data$species %in% unmatched_data, c("species", "type")] %>% 
    unique() %>%
    arrange(species)
  for (i in 1:nrow(data_only_info)) {
    cat(sprintf("  - %s [%s]\n", data_only_info$species[i], data_only_info$type[i]))
  }
}

# Check for any remaining unmatched tree species
if (tree_only > 0) {
  cat("\nSpecies ONLY in tree (no match found):\n")
  for (sp in sort(unmatched_tree)) {
    cat("  -", sp, "\n")
  }
}
```

```{r annotate-species}


# Define gibbon species keys
gibbon_keys <- c(
  "Nomascus leucogenys",
  "Hylobates pileatus",
  "Hylobates moloch",
  "Symphalangus syndactylus",
  "Hoolock hoolock"
)

# Species to add to the focal set (based on mentions + decision to include)
focal_additions <- c(
  "Pan troglodytes",
  "Mandrillus sphinx",
  "Macaca mulatta",
  "Pongo abelii",
  "Gorilla gorilla"
)

# Tag dataset type
df_tagged <- data %>%
  mutate(
    inclusion = if_else(combined_photos >= 100, "yes", "no"),
    type_dataset = case_when(
      key %in% gibbon_keys ~ "gibbon",
      type == "focal" | key %in% focal_additions ~ "focal",
      TRUE ~ "additional"
    )
  )

# Count species by dataset type (with ≥100 photos)
df_tagged %>%
  filter(inclusion == "yes") %>%
  count(type_dataset, name = "n_species_over_100")

```


```{r dataviz-ggtreeExtra-defunc}
# === CREATE VISUALIZATION ===
cat("\n=== CREATING VISUALIZATION ===\n")

# Create tip data frame with flexible matching
tip_data <- data.frame(
  label = tree$tip.label,
  tree_species = gsub("_", " ", tree$tip.label),
  stringsAsFactors = FALSE
)

# For each tree species, find its match in the data
tip_data$data_species <- sapply(tip_data$tree_species, match_species, data_all_names)

# Join with data using the matched species name
tip_data <- left_join(
  tip_data, 
  data, 
  by = c("data_species" = "species")
)

# Report any missing data
missing_data <- sum(is.na(tip_data$family))
if (missing_data > 0) {
  cat("Warning:", missing_data, "tree species have no data after matching\n")
  missing_species <- tip_data$tree_species[is.na(tip_data$family)]
  cat("Missing:", paste(missing_species, collapse = ", "), "\n")
}

# Define color schemes
family_colors <- c(
  "Atelidae" = "#8B0000", 
  "Cebidae" = "#FF6347",
  "Pitheciidae" = "#FF8C00", 
  "Callitrichidae" = "#FFD700",
  "Cercopithecidae" = "#228B22",
  "Hominidae" = "#4682B4",
  "Hylobatidae" = "#6495ED", 
  "Lorisidae" = "#9370DB",
  "Galagidae" = "#8B008B",
  "Lemuridae" = "#FF1493",
  "Indriidae" = "#FF69B4",
  "Cheirogaleidae" = "#DDA0DD",
  "Lepilemuridae" = "#D8BFD8",
  "Daubentoniidae" = "#BC8F8F",
  "Tarsiidae" = "#708090"
)

# Create base tree
p <- ggtree(tree, layout = "rectangular", size = 0.3) +
  geom_tiplab(size = 1.5, align = TRUE, linesize = 0.1)

# Add family dots
p <- p + geom_fruit(
  data = tip_data,
  geom = geom_point,
  mapping = aes(y = label, color = family),
  size = 2.5,
  offset = 0.01,
  pwidth = 0.05
) +
  scale_color_manual(values = family_colors, name = "Family", na.value = "grey50")

# Add binary traits heatmap
binary_data <- tip_data %>%
  mutate(
    `Natal coat` = factor(ifelse(natal_coat == 1, "Present", "Absent"), 
                         levels = c("Absent", "Present")),
    `Sexual dichromatism` = factor(ifelse(hair_dichromatism_any == 1, "Present", "Absent"),
                                  levels = c("Absent", "Present")),
    `Hair dimorphism` = factor(ifelse(hair_dimorphism == 1, "Present", "Absent"),
                              levels = c("Absent", "Present"))
  ) %>%
  select(label, `Natal coat`, `Sexual dichromatism`, `Hair dimorphism`) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value")

p <- p + new_scale_fill() +
  geom_fruit(
    data = binary_data,
    geom = geom_tile,
    mapping = aes(y = label, x = trait, fill = value),
    offset = 0.02,
    pwidth = 0.15
  ) +
  scale_fill_manual(
    values = c("Absent" = "white", "Present" = "#2166AC"),
    name = "Binary Traits",
    na.value = "grey80"
  )

# Add ontogenetic trajectory  
trajectory_colors <- c(
  "stable" = "#E5E5E5",
  "early_dimorphism" = "#E41A1C",
  "darkening" = "#377EB8", 
  "lightening" = "#4DAF4A",
  "variable" = "#984EA3"
)

onto_data <- tip_data %>%
  select(label, ontogenetic_trajectory_color) %>%
  mutate(trajectory = factor(ontogenetic_trajectory_color))

p <- p + new_scale_fill() +
  geom_fruit(
    data = onto_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = trajectory),
    offset = 0.03,
    pwidth = 0.05
  ) +
  scale_fill_manual(
    values = trajectory_colors,
    name = "Ontogenetic\nTrajectory",
    na.value = "grey50"
  )

# Add photo counts (log scale stacked bar)
# Keep data in wide format for stacking
photo_data <- tip_data %>%
  mutate(
    iNaturalist = log10(inat_total_photos + 1),
    GBIF_obs = log10(gbif_photos + 1), 
    GBIF_spec = log10(gbif_specimen_photos + 1)
  ) %>%
  # Replace NAs with 0
  mutate(across(c(iNaturalist, GBIF_obs, GBIF_spec), ~replace_na(., 0))) %>%
  select(label, iNaturalist, GBIF_obs, GBIF_spec)

# Add photo counts (log scale stacked bar)
photo_data_long <- tip_data %>%
  mutate(
    iNaturalist = log10(inat_total_photos + 1),
    GBIF_obs = log10(gbif_photos + 1), 
    GBIF_spec = log10(gbif_specimen_photos + 1)
  ) %>%
  # Replace NAs with 0
  mutate(across(c(iNaturalist, GBIF_obs, GBIF_spec), ~replace_na(., 0))) %>%
  select(label, iNaturalist, GBIF_obs, GBIF_spec) %>%
  pivot_longer(cols = -label, names_to = "source", values_to = "count")

p <- p + new_scale_fill() +
  geom_fruit(
    data = photo_data_long,
    geom = geom_bar,
    mapping = aes(y = label, x = count, fill = source),
    pwidth = 0.3,
    orientation = "y",
    stat = "identity",
    # Remove position parameter - let geom_fruit handle it automatically
    offset = 0.04,
    axis.params = list(
      axis = "x",
      text.size = 1.5,
      title = "Photo count (log10)",
      title.size = 2,
      nbreak = 4
    )
  ) +
  scale_fill_viridis_d(name = "Photo Source", option = "plasma", end = 0.8)

# Final adjustments and convert to rectangular layout
p <- p + 
  layout_rectangular() +  # Convert to rectangular layout
  theme_tree2() +
  theme(
    legend.position = "right",
    legend.box = "vertical",
    legend.margin = margin(0, 0, 0, 0),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  xlim_tree(9)

# # Save outputs
# ggsave("output/primate_phylogeny_annotated.pdf", p, width = 14, height = 18, units = "in")
# ggsave("output/primate_phylogeny_annotated.png", p, width = 14, height = 18, units = "in", dpi = 300)

cat("✓ Visualization saved as primate_phylogeny_annotated.pdf/png\n")

print(p)
```

```{r datavizv2}

# Load required libraries
library(ggtree)
library(ggtreeExtra)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ape)
library(viridis)

# Read the tree and data
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# === SPECIES OVERLAP ANALYSIS ===
cat("=== SPECIES OVERLAP ANALYSIS ===\n\n")

# Extract species names
tree_species <- gsub("_", " ", tree$tip.label)
data_species <- unique(data$species)

cat("Raw counts:\n")
cat("  Tree species:", length(tree_species), "\n")
cat("  Data species:", length(data_species), "\n\n")

# Create a list of ALL possible names for each species in the data
# This accounts for the mixed Callicebus/Plecturocebus naming
data_all_names <- data %>%
  select(species, inat_name, species_binom, key) %>%
  unique() %>%
  mutate(
    # Create a list of all possible names for matching
    all_names = paste(na.omit(c(species, inat_name, species_binom, key)), collapse = "|")
  )

# Function to check if a tree species matches any name variant in data
match_species <- function(tree_sp, data_names_df) {
  for (i in 1:nrow(data_names_df)) {
    # Check all name variants
    if (tree_sp == data_names_df$species[i] ||
        tree_sp == data_names_df$inat_name[i] ||
        tree_sp == data_names_df$species_binom[i] ||
        tree_sp == data_names_df$key[i]) {
      return(data_names_df$species[i])  # Return the primary species name
    }
  }
  # Also check specific mappings
  if (tree_sp == "Trachypithecus johnii" && "Semnopithecus johnii" %in% data_names_df$species) {
    return("Semnopithecus johnii")
  }
  if (tree_sp == "Cercopithecus preussi" && "Allochrocebus preussi" %in% data_names_df$species) {
    return("Allochrocebus preussi")
  }
  if (tree_sp == "Oreonax flavicauda" && "Lagothrix flavicauda" %in% data_names_df$species) {
    return("Lagothrix flavicauda")
  }
  if (tree_sp == "Lagothrix lagotricha" && "Lagothrix lagothricha" %in% data_names_df$species) {
    return("Lagothrix lagothricha")
  }
  return(NA)
}

# Match tree species to data species
tree_matches <- sapply(tree_species, match_species, data_all_names)
matched_species <- unique(na.omit(tree_matches))
unmatched_tree <- tree_species[is.na(tree_matches)]
unmatched_data <- setdiff(data_species, matched_species)

# Calculate final numbers
in_both <- length(matched_species)
tree_only <- length(unmatched_tree)
data_only <- length(unmatched_data)

cat("After flexible name matching:\n")
cat("  Matched species:", in_both, "\n")
cat("  Only in tree:", tree_only, "\n")
cat("  Only in data:", data_only, "\n\n")

# Show matched species by type
matched_data <- data[data$species %in% matched_species, ]
cat("Matched species by type:\n")
type_counts <- table(matched_data$type)
for (type in names(type_counts)) {
  cat(sprintf("  %s: %d\n", type, type_counts[type]))
}

# List species only in data
if (data_only > 0) {
  cat("\nSpecies ONLY in data:\n")
  data_only_info <- data[data$species %in% unmatched_data, c("species", "type")] %>% 
    unique() %>%
    arrange(species)
  for (i in 1:nrow(data_only_info)) {
    cat(sprintf("  - %s [%s]\n", data_only_info$species[i], data_only_info$type[i]))
  }
}

# Check for any remaining unmatched tree species
if (tree_only > 0) {
  cat("\nSpecies ONLY in tree (no match found):\n")
  for (sp in sort(unmatched_tree)) {
    cat("  -", sp, "\n")
  }
}

# === CREATE VISUALIZATION ===
cat("\n=== CREATING VISUALIZATION ===\n")

# Create tip data frame with flexible matching
tip_data <- data.frame(
  label = tree$tip.label,
  tree_species = gsub("_", " ", tree$tip.label),
  stringsAsFactors = FALSE
)

# For each tree species, find its match in the data
tip_data$data_species <- sapply(tip_data$tree_species, match_species, data_all_names)

# Join with data using the matched species name
tip_data <- left_join(
  tip_data, 
  data, 
  by = c("data_species" = "species")
)

# Report any missing data
missing_data <- sum(is.na(tip_data$family))
if (missing_data > 0) {
  cat("Warning:", missing_data, "tree species have no data after matching\n")
  missing_species <- tip_data$tree_species[is.na(tip_data$family)]
  cat("Missing:", paste(missing_species, collapse = ", "), "\n")
}

# Define color schemes with proper phylogenetic ordering
family_colors <- c(
  "Lemuridae" = "#ff69b4",        # hot pink
  "Lepilemuridae" = "#ff1493",    # deep pink
  "Cheirogaleidae" = "#da70d6",   # orchid
  "Indriidae" = "#ba55d3",        # medium orchid
  "Daubentoniidae" = "#9370db",   # medium purple
  "Lorisidae" = "#7b68ee",        # medium slate blue
  "Galagidae" = "#6495ed",        # cornflower blue
  "Tarsiidae" = "#4169e1",        # royal blue
  "Callitrichidae" = "#228b22",   # forest green
  "Cebidae" = "#32cd32",          # lime green
  "Atelidae" = "#006400",         # dark green (for new world monkeys)
  "Pitheciidae" = "#3cb371",      # medium sea green
  "Cercopithecidae" = "#8B4513",  # saddle brown
  "Hylobatidae" = "#ffd700",      # gold
  "Hominidae" = "#dc143c"         # crimson
)

# Create base tree
p <- ggtree(tree, layout = "rectangular", size = 0.3) +
  geom_tiplab(size = 1.5, align = TRUE, linesize = 0.1)

# Add family dots
p <- p + geom_fruit(
  data = tip_data,
  geom = geom_point,
  mapping = aes(y = label, color = family),
  size = 2.5,
  offset = 0.01,
  pwidth = 0.05
) +
  scale_color_manual(values = family_colors, name = "Family", na.value = "grey50")

# Add binary traits as separate columns with different colors
# First: Natal coat (black/white)
natal_data <- tip_data %>%
  mutate(natal = factor(ifelse(natal_coat == 1, "Present", "Absent"), 
                       levels = c("Absent", "Present"))) %>%
  select(label, natal)

p <- p + new_scale_fill() +
  geom_fruit(
    data = natal_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = natal),
    offset = 0.02,
    pwidth = 0.02,
    axis.params = list(axis = "none")  # No axis for this layer
  ) +
  scale_fill_manual(
    values = c("Absent" = "white", "Present" = "black"),
    name = "Natal coat",
    na.value = "grey90"
  )

# Second: Sexual dichromatism (grey/white)
dichromatism_data <- tip_data %>%
  mutate(dichromatism = factor(ifelse(hair_dichromatism_any == 1, "Present", "Absent"),
                              levels = c("Absent", "Present"))) %>%
  select(label, dichromatism)

p <- p + new_scale_fill() +
  geom_fruit(
    data = dichromatism_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = dichromatism),
    offset = 0.005,
    pwidth = 0.02,
    axis.params = list(axis = "none")  # No axis for this layer
  ) +
  scale_fill_manual(
    values = c("Absent" = "white", "Present" = "grey50"),
    name = "Sexual\ndichromatism",
    na.value = "grey90"
  )

# Third: Hair dimorphism (another grey scale)
dimorphism_data <- tip_data %>%
  mutate(dimorphism = factor(ifelse(hair_dimorphism == 1, "Present", "Absent"),
                            levels = c("Absent", "Present"))) %>%
  select(label, dimorphism)

p <- p + new_scale_fill() +
  geom_fruit(
    data = dimorphism_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = dimorphism),
    offset = 0.005,
    pwidth = 0.02,
    axis.params = list(axis = "none")  # No axis for this layer
  ) +
  scale_fill_manual(
    values = c("Absent" = "white", "Present" = "darkgrey"),
    name = "Hair\ndimorphism",
    na.value = "grey90"
  )

# Add ontogenetic trajectory (excluding stable/mono_stable from colors)
trajectory_colors <- c(
  "early_dimorphism" = "#E41A1C",
  "darkening" = "#377EB8", 
  "lightening" = "#4DAF4A",
  "variable" = "#984EA3"
  # stable or mono_stable will use na.value color
)

onto_data <- tip_data %>%
  select(label, ontogenetic_trajectory_color) %>%
  # Replace "stable" or "mono_stable" with NA so it doesn't get a color
  mutate(trajectory = ifelse(ontogenetic_trajectory_color %in% c("stable", "mono_stable"), 
                            NA, 
                            ontogenetic_trajectory_color)) %>%
  mutate(trajectory = factor(trajectory))

p <- p + new_scale_fill() +
  geom_fruit(
    data = onto_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = trajectory),
    offset = 0.01,
    pwidth = 0.03,
    axis.params = list(axis = "none")  # No axis for this layer
  ) +
  scale_fill_manual(
    values = trajectory_colors,
    name = "Ontogenetic\nTrajectory",
    na.value = "white"  # White for stable/mono_stable and true NAs
  )

# Add photo counts (log scale stacked bar)
photo_data_long <- tip_data %>%
  mutate(
    iNaturalist = log10(inat_total_photos + 1),
    GBIF_obs = log10(gbif_photos + 1), 
    GBIF_spec = log10(gbif_specimen_photos + 1)
  ) %>%
  # Replace NAs with 0 - THIS WAS MISSING
  mutate(across(c(iNaturalist, GBIF_obs, GBIF_spec), ~replace_na(., 0))) %>%
  select(label, iNaturalist, GBIF_obs, GBIF_spec) %>%
  pivot_longer(cols = -label, names_to = "source", values_to = "count")

p <- p + new_scale_fill() +
  geom_fruit(
    data = photo_data_long,
    geom = geom_bar,
    mapping = aes(y = label, x = count, fill = source),
    pwidth = 0.3,
    orientation = "y",  # THIS WAS MISSING
    stat = "identity",
    # NO POSITION PARAMETER - THIS IS KEY!
    offset = 0.04,
    axis.params = list(
      axis = "x",
      text.size = 1.5,
      title = "Photo count (log10)",
      title.size = 2,
      nbreak = 4
    )
  ) +
  scale_fill_viridis_d(name = "Photo Source", option = "plasma", end = 0.8)

# Final adjustments
p <- p + 
  theme_tree2() +
  theme(
    legend.position = "right",
    legend.box = "vertical",
    legend.margin = margin(0, 0, 0, 0),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  xlim_tree(9)

# Save outputs
ggsave("output/primate_phylogeny_annotated.pdf", p, width = 16, height = 20, units = "in")
ggsave("output/primate_phylogeny_annotated.png", p, width = 16, height = 20, units = "in", dpi = 300)

cat("✓ Visualization saved as primate_phylogeny_annotated.pdf/png\n")

# Print the plot
print(p)

# Alternative: If stacked bars still fail, use this heatmap approach instead
if (FALSE) {  # Change to TRUE to use alternative visualization
  # Alternative visualization using heatmap for photo counts
  photo_data_wide <- tip_data %>%
    mutate(
      iNaturalist = log10(inat_total_photos + 1),
      `GBIF obs` = log10(gbif_photos + 1), 
      `GBIF spec` = log10(gbif_specimen_photos + 1)
    ) %>%
    select(label, iNaturalist, `GBIF obs`, `GBIF spec`) %>%
    pivot_longer(cols = -label, names_to = "source", values_to = "count")
  
  p_alt <- p + new_scale_fill() +
    geom_fruit(
      data = photo_data_wide,
      geom = geom_tile,
      mapping = aes(y = label, x = source, fill = count),
      pwidth = 0.15,
      offset = 0.02,
      axis.params = list(
        axis = "x",
        text.angle = 45,
        text.size = 1.2,
        hjust = 1
      )
    ) +
    scale_fill_viridis_c(
      name = "Photo count\n(log10)",
      option = "plasma",
      na.value = "white"
    )
  
  # ggsave("output/primate_phylogeny_heatmap.pdf", p_alt, width = 16, height = 20, units = "in")
}
```

```{r dataviz3}
# Load required libraries
library(ggtree)
library(ggtreeExtra)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ape)
library(viridis)
library(ggnewscale)

# Read the tree and data
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# === SPECIES OVERLAP ANALYSIS ===
cat("=== SPECIES OVERLAP ANALYSIS ===\n\n")

# Extract species names
tree_species <- gsub("_", " ", tree$tip.label)
data_species <- unique(data$species)

cat("Raw counts:\n")
cat("  Tree species:", length(tree_species), "\n")
cat("  Data species:", length(data_species), "\n\n")

# Create a list of ALL possible names for each species in the data
# This accounts for the mixed Callicebus/Plecturocebus naming
data_all_names <- data %>%
  select(species, inat_name, species_binom, key) %>%
  unique() %>%
  mutate(
    # Create a list of all possible names for matching
    all_names = paste(na.omit(c(species, inat_name, species_binom, key)), collapse = "|")
  )

# Function to check if a tree species matches any name variant in data
match_species <- function(tree_sp, data_names_df) {
  for (i in 1:nrow(data_names_df)) {
    # Check all name variants
    if (tree_sp == data_names_df$species[i] ||
        tree_sp == data_names_df$inat_name[i] ||
        tree_sp == data_names_df$species_binom[i] ||
        tree_sp == data_names_df$key[i]) {
      return(data_names_df$species[i])  # Return the primary species name
    }
  }
  
  # Check if species epithet matches with different genus (for Callicebus/Plecturocebus)
  tree_parts <- strsplit(tree_sp, " ")[[1]]
  if (length(tree_parts) == 2 && tree_parts[1] == "Callicebus") {
    tree_epithet <- tree_parts[2]
    for (i in 1:nrow(data_names_df)) {
      # Check if any Plecturocebus species has the same epithet
      if (!is.na(data_names_df$species[i]) && 
          grepl(paste0("Plecturocebus ", tree_epithet), data_names_df$species[i])) {
        return(data_names_df$species[i])
      }
    }
  }
  
  # Also check specific mappings
  if (tree_sp == "Trachypithecus johnii" && "Semnopithecus johnii" %in% data_names_df$species) {
    return("Semnopithecus johnii")
  }
  if (tree_sp == "Cercopithecus preussi" && "Allochrocebus preussi" %in% data_names_df$species) {
    return("Allochrocebus preussi")
  }
  if (tree_sp == "Oreonax flavicauda" && "Lagothrix flavicauda" %in% data_names_df$species) {
    return("Lagothrix flavicauda")
  }
  if (tree_sp == "Lagothrix lagotricha" && "Lagothrix lagothricha" %in% data_names_df$species) {
    return("Lagothrix lagothricha")
  }
  return(NA)
}

# Match tree species to data species
tree_matches <- sapply(tree_species, match_species, data_all_names)
matched_species <- unique(na.omit(tree_matches))
unmatched_tree <- tree_species[is.na(tree_matches)]
unmatched_data <- setdiff(data_species, matched_species)

# Calculate final numbers
in_both <- length(matched_species)
tree_only <- length(unmatched_tree)
data_only <- length(unmatched_data)

cat("After flexible name matching:\n")
cat("  Matched species:", in_both, "\n")
cat("  Only in tree:", tree_only, "\n")
cat("  Only in data:", data_only, "\n\n")

# Show matched species by type
matched_data <- data[data$species %in% matched_species, ]
cat("Matched species by type:\n")
type_counts <- table(matched_data$type)
for (type in names(type_counts)) {
  cat(sprintf("  %s: %d\n", type, type_counts[type]))
}

# List species only in data
if (data_only > 0) {
  cat("\nSpecies ONLY in data:\n")
  data_only_info <- data[data$species %in% unmatched_data, c("species", "type")] %>% 
    unique() %>%
    arrange(species)
  for (i in 1:nrow(data_only_info)) {
    cat(sprintf("  - %s [%s]\n", data_only_info$species[i], data_only_info$type[i]))
  }
}

# Check for any remaining unmatched tree species
if (tree_only > 0) {
  cat("\nSpecies ONLY in tree (no match found):\n")
  for (sp in sort(unmatched_tree)) {
    cat("  -", sp, "\n")
  }
}

# === CREATE VISUALIZATION ===
cat("\n=== CREATING VISUALIZATION ===\n")

# Create tip data frame with flexible matching
tip_data <- data.frame(
  label = tree$tip.label,
  tree_species = gsub("_", " ", tree$tip.label),
  stringsAsFactors = FALSE
)

# For each tree species, find its match in the data
tip_data$data_species <- sapply(tip_data$tree_species, match_species, data_all_names)

# Join with data using the matched species name
tip_data <- left_join(
  tip_data, 
  data, 
  by = c("data_species" = "species")
)

# Fix any NA families by checking the family_trait column
for(i in 1:nrow(tip_data)) {
  if(is.na(tip_data$family[i]) && !is.na(tip_data$family_trait[i])) {
    tip_data$family[i] <- tip_data$family_trait[i]
  }
}

# Report any missing data
missing_data <- sum(is.na(tip_data$family))
if (missing_data > 0) {
  cat("Warning:", missing_data, "tree species have no data after matching\n")
  missing_species <- tip_data$tree_species[is.na(tip_data$family)]
  cat("Missing:", paste(missing_species, collapse = ", "), "\n")
}

# Define color schemes with proper phylogenetic ordering
family_colors <- c(
  "Lemuridae" = "#ff69b4",        # hot pink
  "Lepilemuridae" = "#ff1493",    # deep pink
  "Cheirogaleidae" = "#da70d6",   # orchid
  "Indriidae" = "#ba55d3",        # medium orchid
  "Daubentoniidae" = "#9370db",   # medium purple
  "Lorisidae" = "#7b68ee",        # medium slate blue
  "Galagidae" = "#6495ed",        # cornflower blue
  "Tarsiidae" = "#4169e1",        # royal blue
  "Callitrichidae" = "#228b22",   # forest green
  "Cebidae" = "#32cd32",          # lime green
  "Atelidae" = "#006400",         # dark green (for new world monkeys)
  "Pitheciidae" = "#3cb371",      # medium sea green
  "Cercopithecidae" = "#8B4513",  # saddle brown
  "Hylobatidae" = "#ffd700",      # gold
  "Hominidae" = "#dc143c"         # crimson
)

# Create highlight data for families using MRCA
highlight_data <- data.frame()
family_list <- unique(na.omit(tip_data$family))

for(fam in family_list) {
  fam_tips <- tip_data %>%
    filter(family == fam) %>%
    pull(label)
  
  if(length(fam_tips) > 0) {
    if(length(fam_tips) > 1) {
      # Find most recent common ancestor
      fam_node <- MRCA(tree, fam_tips)
    } else {
      # Single species family
      fam_node <- which(tree$tip.label == fam_tips[1])
    }
    
    if(!is.null(fam_node)) {
      highlight_data <- rbind(highlight_data, data.frame(
        node = fam_node,
        family = fam
      ))
    }
  }
}

# Create base tree with family highlighting
p <- ggtree(tree, layout = "rectangular", size = 0.3) +
  geom_hilight(data = highlight_data, 
               aes(node = node, fill = family),
               alpha = 0.2,
               extend = 0.5) +  # Extend highlighting
  scale_fill_manual(values = family_colors, 
                    name = "Family", 
                    na.value = "transparent") +
  geom_tiplab(size = 1.5, align = TRUE, linesize = 0.1)

# Now we need new_scale_fill() before adding other layers
p <- p + new_scale_fill()

# Add binary traits as separate columns with different colors
# First: Natal coat (black/white)
natal_data <- tip_data %>%
  mutate(natal = factor(ifelse(natal_coat == 1, "Present", "Absent"), 
                       levels = c("Absent", "Present"))) %>%
  select(label, natal)

p <- p + geom_fruit(
    data = natal_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = natal),
    offset = 0.02,
    pwidth = 0.02,
    axis.params = list(axis = "none")  # No axis for this layer
  ) +
  scale_fill_manual(
    values = c("Absent" = "white", "Present" = "black"),
    name = "Natal coat",
    na.value = "grey90"
  )

# Second: Sexual dichromatism (grey/white)
dichromatism_data <- tip_data %>%
  mutate(dichromatism = factor(ifelse(hair_dichromatism_any == 1, "Present", "Absent"),
                              levels = c("Absent", "Present"))) %>%
  select(label, dichromatism)

p <- p + new_scale_fill() +
  geom_fruit(
    data = dichromatism_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = dichromatism),
    offset = 0.005,
    pwidth = 0.02,
    axis.params = list(axis = "none")  # No axis for this layer
  ) +
  scale_fill_manual(
    values = c("Absent" = "white", "Present" = "grey50"),
    name = "Sexual\ndichromatism",
    na.value = "grey90"
  )

# Third: Hair dimorphism (another grey scale)
dimorphism_data <- tip_data %>%
  mutate(dimorphism = factor(ifelse(hair_dimorphism == 1, "Present", "Absent"),
                            levels = c("Absent", "Present"))) %>%
  select(label, dimorphism)

p <- p + new_scale_fill() +
  geom_fruit(
    data = dimorphism_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = dimorphism),
    offset = 0.005,
    pwidth = 0.02,
    axis.params = list(axis = "none")  # No axis for this layer
  ) +
  scale_fill_manual(
    values = c("Absent" = "white", "Present" = "darkgrey"),
    name = "Hair\ndimorphism",
    na.value = "grey90"
  )

# Add ontogenetic trajectory with ALL categories
trajectory_colors <- c(
  "mono_stable" = "#E5E5E5",           # Very light grey
  "mono_maturation" = "#FDB863",       # Light orange
  "early_dimorphism" = "#E66101",      # Dark orange/red
  "male_maturation" = "#B2ABD2",       # Light purple
  "bidirectional_maturation" = "#5E3C99" # Dark purple
)

onto_data <- tip_data %>%
  select(label, ontogenetic_trajectory_color) %>%
  mutate(trajectory = factor(ontogenetic_trajectory_color, 
                           levels = names(trajectory_colors)))

p <- p + new_scale_fill() +
  geom_fruit(
    data = onto_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = trajectory),
    offset = 0.01,
    pwidth = 0.03,
    axis.params = list(axis = "none")  # No axis for this layer
  ) +
  scale_fill_manual(
    values = trajectory_colors,
    name = "Ontogenetic\nTrajectory",
    na.value = "white",
    drop = FALSE  # Show all categories in legend
  )

# Add photo counts (log scale stacked bar) - FIXED version
photo_data_long <- tip_data %>%
  mutate(
    iNaturalist = log10(inat_total_photos + 1),
    GBIF_obs = log10(gbif_photos + 1), 
    GBIF_spec = log10(gbif_specimen_photos + 1)
  ) %>%
  # Replace NAs with 0
  mutate(across(c(iNaturalist, GBIF_obs, GBIF_spec), ~replace_na(., 0))) %>%
  select(label, iNaturalist, GBIF_obs, GBIF_spec) %>%
  pivot_longer(cols = -label, names_to = "source", values_to = "count")

p <- p + new_scale_fill() +
  geom_fruit(
    data = photo_data_long,
    geom = geom_bar,
    mapping = aes(y = label, x = count, fill = source),
    pwidth = 0.3,
    orientation = "y",
    stat = "identity",
    offset = 0.04,
    axis.params = list(
      axis = "x",
      text.size = 1.5,
      title = "Photo count (log10)",
      title.size = 2,
      nbreak = 4
    )
  ) +
  scale_fill_viridis_d(
    name = "Photo Source",
    option = "plasma",
    end = 0.8,
    labels = c("iNaturalist" = "iNaturalist", 
               "GBIF_obs" = "GBIF obs", 
               "GBIF_spec" = "GBIF specimens")
  )

# Final adjustments - NO xlim_tree()!
p <- p + 
  theme_tree2() +
  theme(
    legend.position = "right",
    legend.box = "vertical",
    legend.margin = margin(0, 0, 0, 0),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    plot.margin = margin(10, 80, 10, 10),  # Add more right margin for legends
    legend.spacing = unit(0.1, "cm"),
    # Remove any x-axis elements except for the photo panel
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank()
  )
  # DO NOT include xlim_tree() - this creates unwanted x-axis!

# Save outputs
# ggsave("output/primate_phylogeny_annotated.pdf", p, width = 16, height = 20, units = "in")
# ggsave("output/primate_phylogeny_annotated.png", p, width = 16, height = 20, units = "in", dpi = 300)

cat("✓ Visualization saved as primate_phylogeny_annotated.pdf/png\n")

# Print the plot
print(p)
```

## superfamilies

```{r just-highlight}
# Load required libraries
library(ggtree)
library(ggplot2)
library(dplyr)
library(ape)
library(viridis)

# Read the tree and data
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# Create tip data with species matching (using your match_species function)
tip_data <- data.frame(
  label = tree$tip.label,
  tree_species = gsub("_", " ", tree$tip.label),
  stringsAsFactors = FALSE
)

# Match to data (simplified for this example)
tip_data$data_species <- sapply(tip_data$tree_species, match_species, data_all_names)
tip_data <- left_join(tip_data, data, by = c("data_species" = "species"))

# Fix missing families
for(i in 1:nrow(tip_data)) {
  if(is.na(tip_data$family[i]) && !is.na(tip_data$family_trait[i])) {
    tip_data$family[i] <- tip_data$family_trait[i]
  }
}

# Define superfamily mappings
superfamily_mapping <- list(
  Lemuroidea = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),  # Added other lemur families
  Daubentonioidea = c("Daubentoniidae"),
  Lorisoidea = c("Lorisidae", "Galagidae"),
  Tarsioidea = c("Tarsiidae"),
  Ceboidea = c("Callitrichidae", "Cebidae", "Atelidae", "Aotidae", "Pitheciidae"),  # Added Pitheciidae
  Cercopithecoidea = c("Cercopithecidae"),
  Hominoidea = c("Hylobatidae", "Hominidae")
)

# Add superfamily column to tip_data
tip_data$superfamily <- NA
for(sf in names(superfamily_mapping)) {
  families <- superfamily_mapping[[sf]]
  tip_data$superfamily[tip_data$family %in% families] <- sf
}

# Order superfamilies from furthest to closest to humans
superfamily_order <- c("Lemuroidea", "Daubentonioidea", "Lorisoidea", 
                       "Tarsioidea", "Ceboidea", "Cercopithecoidea", "Hominoidea")

# Create viridis colors for superfamilies
superfamily_colors <- setNames(
  viridis(length(superfamily_order), option = "viridis"),
  superfamily_order
)

# Create highlight data for superfamilies using MRCA
highlight_data <- data.frame()

for(sf in superfamily_order) {
  sf_tips <- tip_data %>%
    filter(superfamily == sf) %>%
    pull(label)
  
  if(length(sf_tips) > 0) {
    if(length(sf_tips) > 1) {
      # Find most recent common ancestor
      sf_node <- MRCA(tree, sf_tips)
    } else {
      # Single species superfamily
      sf_node <- which(tree$tip.label == sf_tips[1])
    }
    
    if(!is.null(sf_node)) {
      highlight_data <- rbind(highlight_data, data.frame(
        node = sf_node,
        superfamily = sf
      ))
    }
  }
}

# Set factor levels for ordering
highlight_data$superfamily <- factor(highlight_data$superfamily, levels = superfamily_order)

# Create the superfamily tree
p_superfamily <- ggtree(tree, layout = "rectangular", size = 0.4) +
  geom_hilight(data = highlight_data, 
               aes(node = node, fill = superfamily),
               alpha = 0.3,
               extend = 0.8) +
  scale_fill_viridis_d(
    name = "Superfamily",
    option = "viridis",
    begin = 0,
    end = 0.95,
    direction = 1  # Blue (furthest) to Yellow (closest)
  ) +
  geom_tiplab(size = 2, align = TRUE, linesize = 0.1) +
  theme_tree2() +
  theme(
    legend.position = "right",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 8),
    plot.margin = margin(10, 100, 10, 10)  # Extra right margin for labels
  ) +
  ggtitle("Primate Phylogeny by Superfamily",
          subtitle = "Colored from most distant (blue) to closest to humans (yellow)")

# Save the superfamily tree
ggsave("output/primate_superfamily_tree.pdf", p_superfamily, width = 12, height = 16, units = "in")
ggsave("output/primate_superfamily_tree.png", p_superfamily, width = 12, height = 16, units = "in", dpi = 300)

# Print summary
cat("\n=== SUPERFAMILY SUMMARY ===\n")
for(sf in superfamily_order) {
  count <- sum(tip_data$superfamily == sf, na.rm = TRUE)
  families <- paste(unique(tip_data$family[tip_data$superfamily == sf]), collapse = ", ")
  cat(sprintf("%s (%d species): %s\n", sf, count, families))
}

print(p_superfamily)
```

```{r correctorder}
# Load required libraries
library(ggtree)
library(ggtreeExtra)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ape)
library(viridis)
library(ggnewscale)

# Read the tree and data
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# [Include your match_species function and data matching code here]
# ... (keeping your existing matching code)

# Define superfamily mappings
superfamily_mapping <- list(
  Lemuroidea = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea = c("Daubentoniidae"),
  Lorisoidea = c("Lorisidae", "Galagidae"),
  Tarsioidea = c("Tarsiidae"),
  Ceboidea = c("Callitrichidae", "Cebidae", "Atelidae", "Aotidae", "Pitheciidae"),
  Cercopithecoidea = c("Cercopithecidae"),
  Hominoidea = c("Hylobatidae", "Hominidae")
)

# Add superfamily column to tip_data
tip_data$superfamily <- NA
for(sf in names(superfamily_mapping)) {
  families <- superfamily_mapping[[sf]]
  tip_data$superfamily[tip_data$family %in% families] <- sf
}

# Order superfamilies from furthest to closest to humans
superfamily_order <- c("Lemuroidea", "Daubentonioidea", "Lorisoidea", 
                       "Tarsioidea", "Ceboidea", "Cercopithecoidea", "Hominoidea")

# Create ordered tip labels based on superfamily groupings
ordered_tips <- c()
for(sf in superfamily_order) {
  # Get all tips in this superfamily
  sf_tips <- tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%  # Also sort by family within superfamily
    pull(label)
  
  ordered_tips <- c(ordered_tips, sf_tips)
}

# Create superfamily colors
superfamily_colors <- setNames(
  viridis(length(superfamily_order), option = "viridis"),
  superfamily_order
)

# Create highlight data for superfamilies
highlight_data <- data.frame()
for(sf in superfamily_order) {
  sf_tips <- tip_data %>%
    filter(superfamily == sf) %>%
    pull(label)
  
  if(length(sf_tips) > 0) {
    if(length(sf_tips) > 1) {
      sf_node <- MRCA(tree, sf_tips)
    } else {
      sf_node <- which(tree$tip.label == sf_tips[1])
    }
    
    if(!is.null(sf_node)) {
      highlight_data <- rbind(highlight_data, data.frame(
        node = sf_node,
        superfamily = sf
      ))
    }
  }
}

highlight_data$superfamily <- factor(highlight_data$superfamily, levels = superfamily_order)

# Create base tree using ggdensitree with controlled tip order
p <- ggdensitree(list(tree), layout = "rectangular", 
                 tip.order = ordered_tips,  # THIS IS THE KEY!
                 alpha = 1) +
  geom_hilight(data = highlight_data, 
               aes(node = node, fill = superfamily),
               alpha = 0.3,
               extend = 0.8) +
  scale_fill_viridis_d(
    name = "Superfamily",
    option = "viridis",
    begin = 0,
    end = 0.95
  ) +
  geom_tiplab(size = 1.5, align = TRUE, linesize = 0.1)

# Now add all your other layers with new_scale_fill()
p <- p + new_scale_fill()

# Add your binary traits, ontogenetic trajectories, etc...
# [Include all your existing geom_fruit layers here]

# Add photo counts (histogram) - the key visualization you wanted
photo_data_long <- tip_data %>%
  mutate(
    iNaturalist = log10(inat_total_photos + 1),
    GBIF_obs = log10(gbif_photos + 1), 
    GBIF_spec = log10(gbif_specimen_photos + 1)
  ) %>%
  mutate(across(c(iNaturalist, GBIF_obs, GBIF_spec), ~replace_na(., 0))) %>%
  select(label, iNaturalist, GBIF_obs, GBIF_spec) %>%
  pivot_longer(cols = -label, names_to = "source", values_to = "count")

p <- p + new_scale_fill() +
  geom_fruit(
    data = photo_data_long,
    geom = geom_bar,
    mapping = aes(y = label, x = count, fill = source),
    pwidth = 0.3,
    orientation = "y",
    stat = "identity",
    offset = 0.04,
    axis.params = list(
      axis = "x",
      text.size = 1.5,
      title = "Photo count (log10)",
      title.size = 2,
      nbreak = 4
    )
  ) +
  scale_fill_viridis_d(
    name = "Photo Source",
    option = "plasma",
    end = 0.8
  )

# Final adjustments
p <- p + 
  theme_tree2() +
  theme(
    legend.position = "right",
    legend.box = "vertical",
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    plot.margin = margin(10, 80, 10, 10)
  )

print(p)
```

```{r correct-highlight-other-problems}
# Load required libraries
library(ggtree)
library(ggtreeExtra)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ape)
library(viridis)
library(ggnewscale)

# Read the tree and data
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# [Include your match_species function and data matching code here]
# Create tip data frame with flexible matching
tip_data <- data.frame(
  label = tree$tip.label,
  tree_species = gsub("_", " ", tree$tip.label),
  stringsAsFactors = FALSE
)

# For each tree species, find its match in the data
tip_data$data_species <- sapply(tip_data$tree_species, match_species, data_all_names)

# Join with data using the matched species name
tip_data <- left_join(
  tip_data, 
  data, 
  by = c("data_species" = "species")
)

# Fix missing families
for(i in 1:nrow(tip_data)) {
  if(is.na(tip_data$family[i]) && !is.na(tip_data$family_trait[i])) {
    tip_data$family[i] <- tip_data$family_trait[i]
  }
}

# Define superfamily mappings
superfamily_mapping <- list(
  Lemuroidea = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea = c("Daubentoniidae"),
  Lorisoidea = c("Lorisidae", "Galagidae"),
  Tarsioidea = c("Tarsiidae"),
  Ceboidea = c("Callitrichidae", "Cebidae", "Atelidae", "Aotidae", "Pitheciidae"),
  Cercopithecoidea = c("Cercopithecidae"),
  Hominoidea = c("Hylobatidae", "Hominidae")
)

# Add superfamily column to tip_data
tip_data$superfamily <- NA
for(sf in names(superfamily_mapping)) {
  families <- superfamily_mapping[[sf]]
  tip_data$superfamily[tip_data$family %in% families] <- sf
}

# Order superfamilies from furthest to closest to humans
superfamily_order <- c("Lemuroidea", "Daubentonioidea", "Lorisoidea", 
                       "Tarsioidea", "Ceboidea", "Cercopithecoidea", "Hominoidea")

# Create ordered tip labels based on superfamily groupings
ordered_tips <- c()
for(sf in superfamily_order) {
  # Get all tips in this superfamily
  sf_tips <- tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%  # Sort by family within superfamily
    pull(label)
  
  ordered_tips <- c(ordered_tips, sf_tips)
}

# Create highlight data for superfamilies
highlight_data <- data.frame()
for(sf in superfamily_order) {
  sf_tips <- tip_data %>%
    filter(superfamily == sf) %>%
    pull(label)
  
  if(length(sf_tips) > 0) {
    if(length(sf_tips) > 1) {
      sf_node <- MRCA(tree, sf_tips)
    } else {
      sf_node <- which(tree$tip.label == sf_tips[1])
    }
    
    if(!is.null(sf_node)) {
      highlight_data <- rbind(highlight_data, data.frame(
        node = sf_node,
        superfamily = sf
      ))
    }
  }
}

# Set factor levels with correct order for legend
highlight_data$superfamily <- factor(highlight_data$superfamily, 
                                   levels = rev(superfamily_order))

# Create base tree using ggdensitree with controlled tip order
p <- ggdensitree(list(tree), layout = "rectangular", 
                 tip.order = ordered_tips,  # THIS IS THE KEY FOR ORDERING!
                 alpha = 1, size = 0.3) +
  geom_hilight(data = highlight_data, 
               aes(node = node, fill = superfamily),
               alpha = 0.3,
               extend = 0.5) +
  scale_fill_viridis_d(
    name = "Superfamily",
    option = "viridis",
    begin = 0,
    end = 0.95,
    direction = -1  # Reverse color direction to match reversed factor levels
  ) +
  geom_tiplab(size = 1.5, align = TRUE, linesize = 0.1)

# Now add all the data panels using new_scale_fill()
p <- p + new_scale_fill()

# Add binary traits as separate columns
# First: Natal coat (black/white)
natal_data <- tip_data %>%
  mutate(natal = factor(ifelse(natal_coat == 1, "Present", "Absent"), 
                       levels = c("Absent", "Present"))) %>%
  select(label, natal)

p <- p + geom_fruit(
    data = natal_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = natal),
    offset = 0.02,
    pwidth = 0.02,
    axis.params = list(axis = "none")
  ) +
  scale_fill_manual(
    values = c("Absent" = "white", "Present" = "black"),
    name = "Natal coat",
    na.value = "grey90"
  )

# Second: Sexual dichromatism
p <- p + new_scale_fill()

dichromatism_data <- tip_data %>%
  mutate(dichromatism = factor(ifelse(hair_dichromatism_any == 1, "Present", "Absent"),
                              levels = c("Absent", "Present"))) %>%
  select(label, dichromatism)

p <- p + geom_fruit(
    data = dichromatism_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = dichromatism),
    offset = 0.005,
    pwidth = 0.02,
    axis.params = list(axis = "none")
  ) +
  scale_fill_manual(
    values = c("Absent" = "white", "Present" = "grey50"),
    name = "Sexual\ndichromatism",
    na.value = "grey90"
  )

# Third: Hair dimorphism
p <- p + new_scale_fill()

dimorphism_data <- tip_data %>%
  mutate(dimorphism = factor(ifelse(hair_dimorphism == 1, "Present", "Absent"),
                            levels = c("Absent", "Present"))) %>%
  select(label, dimorphism)

p <- p + geom_fruit(
    data = dimorphism_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = dimorphism),
    offset = 0.005,
    pwidth = 0.02,
    axis.params = list(axis = "none")
  ) +
  scale_fill_manual(
    values = c("Absent" = "white", "Present" = "darkgrey"),
    name = "Hair\ndimorphism",
    na.value = "grey90"
  )

# Add ontogenetic trajectory with ALL categories
p <- p + new_scale_fill()

trajectory_colors <- c(
  "mono_stable" = "#E5E5E5",           # Very light grey
  "mono_maturation" = "#FDB863",       # Light orange
  "early_dimorphism" = "#E66101",      # Dark orange/red
  "male_maturation" = "#B2ABD2",       # Light purple
  "bidirectional_maturation" = "#5E3C99" # Dark purple
)

onto_data <- tip_data %>%
  select(label, ontogenetic_trajectory_color) %>%
  mutate(trajectory = factor(ontogenetic_trajectory_color, 
                           levels = names(trajectory_colors)))

p <- p + geom_fruit(
    data = onto_data,
    geom = geom_tile,
    mapping = aes(y = label, fill = trajectory),
    offset = 0.01,
    pwidth = 0.03,
    axis.params = list(axis = "none")
  ) +
  scale_fill_manual(
    values = trajectory_colors,
    name = "Ontogenetic\nTrajectory",
    na.value = "white",
    drop = FALSE
  )

# Add photo counts - FIXED ORIENTATION
p <- p + new_scale_fill()

photo_data_long <- tip_data %>%
  mutate(
    iNaturalist = log10(inat_total_photos + 1),
    GBIF_obs = log10(gbif_photos + 1), 
    GBIF_spec = log10(gbif_specimen_photos + 1)
  ) %>%
  mutate(across(c(iNaturalist, GBIF_obs, GBIF_spec), ~replace_na(., 0))) %>%
  select(label, iNaturalist, GBIF_obs, GBIF_spec) %>%
  pivot_longer(cols = -label, names_to = "source", values_to = "count")

p <- p + geom_fruit(
    data = photo_data_long,
    geom = geom_bar,
    mapping = aes(y = label, x = count, fill = source),
    pwidth = 0.3,
    orientation = "y",  # Horizontal bars
    stat = "identity",
    offset = 0.04,
    axis.params = list(
      axis = "x",
      text.size = 1.2,
      title = "Photo count (log10)",
      title.size = 1.5,
      nbreak = 4
    )
  ) +
  scale_fill_viridis_d(
    name = "Photo Source",
    option = "plasma",
    end = 0.8,
    labels = c("iNaturalist" = "iNaturalist", 
               "GBIF_obs" = "GBIF obs", 
               "GBIF_spec" = "GBIF specimens")
  )

# Final adjustments
p <- p + 
  theme_tree2() +
  theme(
    legend.position = "right",
    legend.box = "vertical",
    legend.margin = margin(0, 0, 0, 0),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    plot.margin = margin(10, 80, 10, 10),
    legend.spacing = unit(0.1, "cm")
  )

# Save outputs
ggsave("primate_phylogeny_superfamily.pdf", p, width = 16, height = 20, units = "in")
ggsave("primate_phylogeny_superfamily.png", p, width = 16, height = 20, units = "in", dpi = 300)

print(p)
```

```{r bleeding-highlight}
# ───────────────────────────────────────────────────────────
# 0  Libraries
# ───────────────────────────────────────────────────────────
library(ggtree)         # ≥3.8
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)

# ───────────────────────────────────────────────────────────
# 1  Read tree and data
# ───────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# helper that returns the best match of a species name
match_species <- function(target, names_vec) {
  i <- match(tolower(target), tolower(names_vec))
  names_vec[i]
}

data_all_names <- data$species              # vector used in match_species

tip_data <- data.frame(
  label        = tree$tip.label,
  tree_species = gsub("_", " ", tree$tip.label),
  stringsAsFactors = FALSE
)
tip_data$data_species <- sapply(tip_data$tree_species,
                                match_species,
                                data_all_names)

tip_data <- left_join(tip_data,
                      data,
                      by = c("data_species" = "species")) %>%
  mutate(family = ifelse(is.na(family) & !is.na(family_trait),
                         family_trait, family))

# ───────────────────────────────────────────────────────────
# 2  Superfamily groups and robust ordered_tips
# ───────────────────────────────────────────────────────────
superfamily_mapping <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae",
                       "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae", "Cebidae",
                       "Atelidae", "Aotidae", "Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae", "Hominidae")
)

tip_data$superfamily <- NA_character_
for(sf in names(superfamily_mapping)) {
  fams <- superfamily_mapping[[sf]]
  tip_data$superfamily[tip_data$family %in% fams] <- sf
}

superfamily_order <- c("Lemuroidea", "Daubentonioidea", "Lorisoidea",
                       "Tarsioidea", "Ceboidea",
                       "Cercopithecoidea", "Hominoidea")

## build ordered_tips safely
ordered_tips <- purrr::map(superfamily_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}) |> unlist(use.names = FALSE)

## append any tips that did NOT fall into a super-family
missing_tips   <- setdiff(tree$tip.label, ordered_tips)
ordered_tips   <- c(ordered_tips, missing_tips)

## sanity checks
if(length(unique(ordered_tips)) != length(tree$tip.label)) {
  dupes <- ordered_tips[duplicated(ordered_tips)]
  stop("Duplicated tip labels in ordered_tips: ",
       paste(dupes, collapse = ", "))
}
if(!setequal(ordered_tips, tree$tip.label)) {
  stop("ordered_tips still does not match tree$tip.label; check name matching.")
}

# ──────────────────────────────────────────────────────────
# 3  Nodes to highlight   ← same code as before
# ──────────────────────────────────────────────────────────
# 

# 1️⃣  compute the tip x-positions once
max_tip_x <- max(ape::node.depth.edgelength(tree)[seq_along(tree$tip.label)])

highlight_data <- purrr::map_dfr(superfamily_order, function(sf) {
  these <- tip_data %>% filter(superfamily == sf) %>% pull(label)
  if(length(these) == 0) return(NULL)
  node <- if(length(these) == 1) which(tree$tip.label == these) else MRCA(tree, these)
  tibble(node = node, superfamily = sf)
})

## ──------  **A.  restrict to tree facet only**  -------─
highlight_data <- highlight_data %>%
  mutate(.panel = "Tree")                     # ← NEW LINE
## ──────────────────────────────────────────────────────────
highlight_data$superfamily <- factor(highlight_data$superfamily,
                                     levels = rev(superfamily_order))

# ──────────────────────────────────────────────────────────
# 4  Base tree (panel "Tree")
# ──────────────────────────────────────────────────────────


# 2️⃣  draw the highlight rectangles with extendto
p <- ggdensitree(list(tree), layout = "rectangular",
                 tip.order = ordered_tips,
                 alpha = 1, size = .3) +
  geom_hilight(data   = highlight_data,
               aes(node = node, fill = superfamily),
               alpha    = .30,
               extendto = max_tip_x) +      # ← use extendto, drop extend
  scale_fill_viridis_d(name = "Superfamily",
                       option = "viridis",
                       begin  = 0, end = .95,
                       direction = -1) +
  geom_tiplab(size = 1.5, align = TRUE, linesize = .1) +
  theme_tree2() +
  theme(axis.text.x  = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.line.x  = element_blank())

# ───────────────────────────────────────────────────────────
# 5  Trait matrix  (panel 2)  –  NO y aesthetic
# ───────────────────────────────────────────────────────────
p <- p + new_scale_fill()

trait_levels <- c("Natal", "Dichromatism", "Dimorphism", "Trajectory")

trait_long <- tip_data %>%
  transmute(
    label,
    Natal         = ifelse(natal_coat == 1,            "Natal_Present",        "Absent"),
    Dichromatism  = ifelse(hair_dichromatism_any == 1, "Dichromatism_Present", "Absent"),
    Dimorphism    = ifelse(hair_dimorphism == 1,       "Dimorphism_Present",   "Absent"),
    Trajectory    = ontogenetic_trajectory_color
  ) %>%
  pivot_longer(-label, names_to = "trait", values_to = "state") %>%
  mutate(trait_idx = match(trait, trait_levels))

trait_cols <- c(
  Absent                   = "white",
  Natal_Present            = "black",
  Dichromatism_Present     = "grey50",
  Dimorphism_Present       = "darkgrey",
  mono_stable              = "#E5E5E5",
  mono_maturation          = "#FDB863",
  early_dimorphism         = "#E66101",
  male_maturation          = "#B2ABD2",
  bidirectional_maturation = "#5E3C99"
)

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = trait_idx, fill = state),   # y removed
    width   = .25
  ) +
  scale_fill_manual(values = trait_cols,
                    name   = "Traits",
                    na.value = "grey90")

# ───────────────────────────────────────────────────────────
# 6  Photo counts  (panel 3)  –  NO y aesthetic
# ───────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  mutate(
    iNaturalist = log10(inat_total_photos + 1),
    GBIF_obs    = log10(gbif_photos        + 1),
    GBIF_spec   = log10(gbif_specimen_photos + 1)
  ) %>%
  mutate(across(c(iNaturalist, GBIF_obs, GBIF_spec),
                ~ tidyr::replace_na(., 0))) %>%
  select(label, iNaturalist, GBIF_obs, GBIF_spec) %>%
  pivot_longer(-label, names_to = "source", values_to = "count")

p <- facet_plot(
        p,
        panel   = "Photo counts",
        data    = photo_long,
        geom    = geom_col,
        mapping = aes(x = count, fill = source),  # y removed
        stat    = "identity",
        orientation = "y",
        width   = .35
     ) +
     scale_fill_viridis_d(
       name   = "Photo source",
       option = "plasma",
       end    = .8,
       labels = c(iNaturalist = "iNaturalist",
                  GBIF_obs    = "GBIF obs",
                  GBIF_spec   = "GBIF specimens"))

# ───────────────────────────────────────────────────────────
# 7  Save or print plot       (unchanged)
# ───────────────────────────────────────────────────────────
ggsave("primate_phylogeny_superfamily.pdf",
       plot  = p, width = 16, height = 20, units = "in")
ggsave("primate_phylogeny_superfamily.png",
       plot  = p, width = 16, height = 20, units = "in", dpi = 300)

print(p)


```

```{r}
# ───────────────────────────────────────────────────────────
# 0  Libraries
# ───────────────────────────────────────────────────────────
library(ggtree)         # ≥3.8
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)

# ───────────────────────────────────────────────────────────
# 1  Read tree and data
# ───────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# helper that returns the best match of a species name
match_species <- function(target, names_vec) {
  i <- match(tolower(target), tolower(names_vec))
  names_vec[i]
}

data_all_names <- data$species              # vector used in match_species

tip_data <- data.frame(
  label        = tree$tip.label,
  tree_species = gsub("_", " ", tree$tip.label),
  stringsAsFactors = FALSE
)
tip_data$data_species <- sapply(tip_data$tree_species,
                                match_species,
                                data_all_names)

tip_data <- left_join(tip_data,
                      data,
                      by = c("data_species" = "species")) %>%
  mutate(family = ifelse(is.na(family) & !is.na(family_trait),
                         family_trait, family))

# ───────────────────────────────────────────────────────────
# 2  Superfamily groups and robust ordered_tips
# ───────────────────────────────────────────────────────────
superfamily_mapping <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae",
                       "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae", "Cebidae",
                       "Atelidae", "Aotidae", "Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae", "Hominidae")
)

tip_data$superfamily <- NA_character_
for(sf in names(superfamily_mapping)) {
  fams <- superfamily_mapping[[sf]]
  tip_data$superfamily[tip_data$family %in% fams] <- sf
}

superfamily_order <- c("Lemuroidea", "Daubentonioidea", "Lorisoidea",
                       "Tarsioidea", "Ceboidea",
                       "Cercopithecoidea", "Hominoidea")

## build ordered_tips safely
ordered_tips <- purrr::map(superfamily_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}) |> unlist(use.names = FALSE)

## append any tips that did NOT fall into a super-family
missing_tips   <- setdiff(tree$tip.label, ordered_tips)
ordered_tips   <- c(ordered_tips, missing_tips)

## sanity checks
if(length(unique(ordered_tips)) != length(tree$tip.label)) {
  dupes <- ordered_tips[duplicated(ordered_tips)]
  stop("Duplicated tip labels in ordered_tips: ",
       paste(dupes, collapse = ", "))
}
if(!setequal(ordered_tips, tree$tip.label)) {
  stop("ordered_tips still does not match tree$tip.label; check name matching.")
}

# ──────────────────────────────────────────────────────────
# 3  Nodes to highlight
# ──────────────────────────────────────────────────────────
highlight_data <- purrr::map_dfr(superfamily_order, function(sf) {
  these <- tip_data %>% filter(superfamily == sf) %>% pull(label)
  if(length(these) == 0) return(NULL)
  node <- if(length(these) == 1) which(tree$tip.label == these) else MRCA(tree, these)
  tibble(node = node, superfamily = sf)
})

# Create the .panel column to restrict highlights to tree panel
highlight_data <- highlight_data %>%
  mutate(.panel = "Tree")

highlight_data$superfamily <- factor(highlight_data$superfamily,
                                     levels = rev(superfamily_order))

# ──────────────────────────────────────────────────────────
# 4  Base tree (panel "Tree")
# ──────────────────────────────────────────────────────────
# KEY FIX: Use extend instead of extendto, with a smaller value
p <- ggdensitree(list(tree), layout = "rectangular",
                 tip.order = ordered_tips,
                 alpha = 1, size = .3) +
  geom_hilight(data   = highlight_data,
               aes(node = node, fill = superfamily),
               alpha    = .30,
               extend   = 0.35) +  # Changed from extendto to extend with smaller value
  scale_fill_viridis_d(name = "Superfamily",
                       option = "viridis",
                       begin  = 0, end = .95,
                       direction = -1) +
  geom_tiplab(size = 1.5, align = TRUE, linesize = .1) +
  theme_tree2() +
  theme(axis.text.x  = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.line.x  = element_blank())

# ───────────────────────────────────────────────────────────
# 5  Trait matrix  (panel "Traits")
# ───────────────────────────────────────────────────────────
p <- p + new_scale_fill()

trait_levels <- c("Natal", "Dichromatism", "Dimorphism", "Trajectory")

trait_long <- tip_data %>%
  transmute(
    label,
    Natal         = ifelse(natal_coat == 1,            "Natal_Present",        "Absent"),
    Dichromatism  = ifelse(hair_dichromatism_any == 1, "Dichromatism_Present", "Absent"),
    Dimorphism    = ifelse(hair_dimorphism == 1,       "Dimorphism_Present",   "Absent"),
    Trajectory    = ontogenetic_trajectory_color
  ) %>%
  pivot_longer(-label, names_to = "trait", values_to = "state") %>%
  mutate(trait_idx = match(trait, trait_levels))

trait_cols <- c(
  Absent                   = "white",
  Natal_Present            = "black",
  Dichromatism_Present     = "grey50",
  Dimorphism_Present       = "darkgrey",
  mono_stable              = "#E5E5E5",
  mono_maturation          = "#FDB863",
  early_dimorphism         = "#E66101",
  male_maturation          = "#B2ABD2",
  bidirectional_maturation = "#5E3C99"
)

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = trait_idx, fill = state),
    width   = .9  # Increased width for better visibility
  ) +
  scale_fill_manual(values = trait_cols,
                    name   = "Traits",
                    na.value = "grey90")

# ───────────────────────────────────────────────────────────
# 6  Photo counts  (panel "Photo counts")
# ───────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  mutate(
    iNaturalist = log10(inat_total_photos + 1),
    GBIF_obs    = log10(gbif_photos        + 1),
    GBIF_spec   = log10(gbif_specimen_photos + 1)
  ) %>%
  mutate(across(c(iNaturalist, GBIF_obs, GBIF_spec),
                ~ tidyr::replace_na(., 0))) %>%
  select(label, iNaturalist, GBIF_obs, GBIF_spec) %>%
  pivot_longer(-label, names_to = "source", values_to = "count")

p <- facet_plot(
        p,
        panel   = "Photo counts",
        data    = photo_long,
        geom    = geom_col,
        mapping = aes(x = count, fill = source),
        stat    = "identity",
        orientation = "y",
        width   = .35
     ) +
     scale_fill_viridis_d(
       name   = "Photo source",
       option = "plasma",
       end    = .8,
       labels = c(iNaturalist = "iNaturalist",
                  GBIF_obs    = "GBIF obs",
                  GBIF_spec   = "GBIF specimens"))

# Add axis parameters for the photo counts panel
# p <- p + facet_plot(
#   panel = "Photo counts",
#   theme = theme(
#     axis.title.x = element_text(size = 10),
#     axis.text.x = element_text(size = 8)
#   )
# ) +
#   xlab("Photo count (log10)")  # Add x-axis label

# ───────────────────────────────────────────────────────────
# 7  Final theme adjustments and save
# ───────────────────────────────────────────────────────────
p <- p + 
  theme(
    legend.position = "right",
    legend.box = "vertical",
    legend.margin = margin(0, 0, 0, 0),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    plot.margin = margin(10, 80, 10, 10),
    legend.spacing = unit(0.1, "cm")
  )

# Save outputs
ggsave("primate_phylogeny_superfamily.pdf",
       plot  = p, width = 16, height = 20, units = "in")
ggsave("primate_phylogeny_superfamily.png",
       plot  = p, width = 16, height = 20, units = "in", dpi = 300)

print(p)
```

```{r}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}

tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data (once!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · TREE panel   (ordinary ggtree)
# ──────────────────────────────────────────────────────────
p <- ggtree(tree,
            layout    = "rectangular",
            tip_order = ordered_tips,
            size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  scale_fill_viridis_d(
    name      = "Superfamily",
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5 · TRAITS panel
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

trait_levels <- c("Natal","Dichromatism","Dimorphism","Trajectory")
trait_long   <- tip_data %>%
  transmute(
    label,
    Natal        = ifelse(natal_coat == 1,            "Natal_Present",        "Absent"),
    Dichromatism = ifelse(hair_dichromatism_any == 1, "Dichromatism_Present", "Absent"),
    Dimorphism   = ifelse(hair_dimorphism == 1,       "Dimorphism_Present",   "Absent"),
    Trajectory   = ontogenetic_trajectory_color
  ) %>%
  pivot_longer(-label, names_to = "trait", values_to = "state") %>%
  mutate(trait_idx = match(trait, trait_levels))

trait_cols <- c(
  Absent                   = "white",
  Natal_Present            = "black",
  Dichromatism_Present     = "grey50",
  Dimorphism_Present       = "darkgrey",
  mono_stable              = "#E5E5E5",
  mono_maturation          = "#FDB863",
  early_dimorphism         = "#E66101",
  male_maturation          = "#B2ABD2",
  bidirectional_maturation = "#5E3C99"
)

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = trait_idx, fill = state),
    width   = 0.9
  ) +
  scale_fill_manual(values = trait_cols, name = "Traits", na.value = "grey90")

# ──────────────────────────────────────────────────────────
# 6 · PHOTO-count panel
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos,    0),
    GBIF_obs    = replace_na(gbif_photos,          0),
    GBIF_spec   = replace_na(gbif_specimen_photos, 0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count")

p <- facet_plot(
  p,
  panel        = "Photo counts",
  data         = photo_long,
  geom         = geom_col,
  mapping      = aes(x = count, fill = source),
  stat         = "identity",
  orientation  = "y",
  width        = 0.35,
  axis.params  = list(
    axis       = "x",
    text.size  = 2,
    title      = "Photo count",
    title.size = 2.5,
    nbreak     = 6
  )
) +
  scale_x_log10(
    breaks = c(1, 10, 100, 1e3, 1e4, 1e5),
    labels = comma
  ) +
  scale_fill_viridis_d(
    name   = "Photo source",
    option = "plasma",
    end    = .8,
    labels = c(
      iNaturalist = "iNaturalist",
      GBIF_obs    = "GBIF obs",
      GBIF_spec   = "GBIF specimens")
  )

# ──────────────────────────────────────────────────────────
# 7 · facet widths + global theme blanks
# ──────────────────────────────────────────────────────────
p <- facet_widths(p, c(Tree = 2, Traits = 0.5, `Photo counts` = 1)) +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),

    legend.position  = "right",
    legend.box       = "vertical",
    legend.text      = element_text(size = 7),
    legend.title     = element_text(size = 8, face = "bold"),
    plot.margin      = margin(10, 50, 10, 10)
  )

# ──────────────────────────────────────────────────────────
# 8 · export
# ──────────────────────────────────────────────────────────
ggsave("primate_phylogeny_superfamily.pdf", p, width = 7, height = 16, units = "in")
ggsave("primate_phylogeny_superfamily.png", p, width = 7, height = 16, units = "in", dpi = 300)

print(p)

```


```{r}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}

tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · TREE panel with node labels
# ──────────────────────────────────────────────────────────
p <- ggtree(tree,
            layout    = "rectangular", 
            tip_order = ordered_tips,
            size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  # Add superfamily labels using panel-specific data
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3,
    fontface = "bold",
    hjust = 1.1,
    inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1,
    guide     = "none"  # Remove the superfamily legend
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5 · TRAITS panel (only dichromatism, dimorphism, natal)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

# Prepare trait data - with specific colors for each trait
trait_long <- tip_data %>%
  select(label, natal_coat, hair_dichromatism_any, hair_dimorphism) %>%
  mutate(
    Natal = ifelse(natal_coat == 1, 1, 0),
    Dichromatism = ifelse(hair_dichromatism_any == 1, 1, 0),  # Changed to 1
    Dimorphism = ifelse(hair_dimorphism == 1, 1, 0)           # Changed to 1
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(
    trait_idx = match(trait, c("Natal", "Dichromatism", "Dimorphism")),
    # Create color categories
    color_cat = case_when(
      trait == "Natal" & value == 1 ~ "Natal present",
      trait == "Dichromatism" & value == 1 ~ "Dichromatism present",
      trait == "Dimorphism" & value == 1 ~ "Dimorphism present",
      TRUE ~ "Absent"
    )
  )

# Define colors
trait_colors <- c(
  "Natal present" = "#2ECC71",         # Green
  "Dichromatism present" = "#E91E63",  # Pink
  "Dimorphism present" = "#3498DB",    # Blue
  "Absent" = "white"
)

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = trait_idx, fill = color_cat),
    width   = 0.9
  ) +
  scale_fill_manual(
    values = trait_colors,
    name = "Traits",
    breaks = c("Natal present", "Dichromatism present", "Dimorphism present"),
    labels = c("Natal coat", "Dichromatism", "Dimorphism")
  )

# ──────────────────────────────────────────────────────────
# 6 · PHOTO-count panel
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos,    0),
    GBIF_obs    = replace_na(gbif_photos,          0),
    GBIF_spec   = replace_na(gbif_specimen_photos, 0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count")

p <- facet_plot(
  p,
  panel        = "Photo counts",
  data         = photo_long,
  geom         = geom_col,
  mapping      = aes(x = count, fill = source),
  stat         = "identity",
  orientation  = "y",
  width        = 0.35,
  axis.params  = list(
    axis       = "x",
    text.size  = 2,
    title      = "Photo count",
    title.size = 2.5,
    nbreak     = 6
  )
) +
  scale_x_log10(
    breaks = c(1, 10, 100, 1e3, 1e4, 1e5),
    labels = comma
  ) +
  scale_fill_viridis_d(
    name   = "Photo source",
    option = "plasma",
    end    = .8,
    labels = c(
      iNaturalist = "iNaturalist",
      GBIF_obs    = "GBIF obs",
      GBIF_spec   = "GBIF specimens")
  )

# ──────────────────────────────────────────────────────────
# 7 · facet widths + global theme
# ──────────────────────────────────────────────────────────
p <- facet_widths(p, c(Tree = 2, Traits = 0.5, `Photo counts` = 1)) +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),

    legend.position  = "right",
    legend.box       = "vertical",
    legend.text      = element_text(size = 7),
    legend.title     = element_text(size = 8, face = "bold"),
    plot.margin      = margin(10, 50, 10, 10)
  )

# ──────────────────────────────────────────────────────────
# 8 · export
# ──────────────────────────────────────────────────────────
ggsave("primate_phylogeny_superfamily.pdf", p, width = 7, height = 16, units = "in")
ggsave("primate_phylogeny_superfamily.png", p, width = 7, height = 16, units = "in", dpi = 300)

print(p)
```


```{r functional}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}

tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · TREE panel with node labels
# ──────────────────────────────────────────────────────────
p <- ggtree(tree,
            layout    = "rectangular", 
            tip_order = ordered_tips,
            size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  # Add superfamily labels using panel-specific data
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3,
    fontface = "bold",
    hjust = 1.1,
    inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1,
    guide     = "none"  # Remove the superfamily legend
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# Add horizontal expansion to accommodate species names
p <- p + hexpand(.4, direction = 1)  # Expand to the right

# ──────────────────────────────────────────────────────────
# 5 · TRAITS panel (only dichromatism, dimorphism, natal)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

# Prepare trait data - with specific colors for each trait
trait_long <- tip_data %>%
  select(label, natal_coat, hair_dichromatism_any, hair_dimorphism) %>%
  mutate(
    Natal = ifelse(natal_coat == 1, 1, 0),
    Dichromatism = ifelse(hair_dichromatism_any == 1, 1, 0),  # Changed to 1
    Dimorphism = ifelse(hair_dimorphism == 1, 1, 0)           # Changed to 1
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(
    trait = factor(trait, levels = c("Natal", "Dichromatism", "Dimorphism")),
    trait_idx = as.numeric(trait),
    # Create color categories
    color_cat = case_when(
      trait == "Natal" & value == 1 ~ "Natal present",
      trait == "Dichromatism" & value == 1 ~ "Dichromatism present",
      trait == "Dimorphism" & value == 1 ~ "Dimorphism present",
      TRUE ~ "Absent"
    )
  )

# Define colors
trait_colors <- c(
  "Natal present" = "#2ECC71",         # Green
  "Dichromatism present" = "#E91E63",  # Pink
  "Dimorphism present" = "#3498DB",    # Blue
  "Absent" = "white"
)

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = trait_idx, fill = color_cat),
    width   = 0.8     # Consistent width for all tiles
  ) +
  scale_x_continuous(
    breaks = 1:3,
    limits = c(0.5, 3.5),
    expand = c(0, 0)
  ) +
  scale_fill_manual(
    values = trait_colors,
    name = "Traits",
    breaks = c("Natal present", "Dichromatism present", "Dimorphism present"),
    labels = c("Natal coat", "Dichromatism", "Dimorphism")
  )

# ──────────────────────────────────────────────────────────
# 6 · PHOTO-count panel
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos,    0),
    GBIF_obs    = replace_na(gbif_photos,          0),
    GBIF_spec   = replace_na(gbif_specimen_photos, 0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count")

p <- facet_plot(
  p,
  panel        = "Photo counts",
  data         = photo_long,
  geom         = geom_col,
  mapping      = aes(x = count, fill = source),
  stat         = "identity",
  orientation  = "y",
  width        = 0.6,
  axis.params  = list(
    axis       = "x",
    text.size  = 2,
    title      = "Photo count",
    title.size = 2.5,
    nbreak     = 6
  )
  ) +
  scale_x_log10(
  breaks = c(10, 100, 1e3, 1e4, 1e5),
  labels = label_number(scale_cut = cut_si("k"))
  ) +
  scale_fill_viridis_d(
    name   = "Photo source",
    option = "plasma",
    end    = .8,
    labels = c(
      iNaturalist = "iNaturalist",
      GBIF_obs    = "GBIF obs",
      GBIF_spec   = "GBIF specimens")
  ) +
  theme(
    axis.text.x = element_text(size = 6),
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 7 · facet widths + global theme
# ──────────────────────────────────────────────────────────
p <- facet_widths(p, c(Tree = 2, Traits = 0.6, `Photo counts` = 1)) +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    # axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),

    legend.position  = "right",
    legend.box       = "vertical",
    legend.text      = element_text(size = 7),
    legend.title     = element_text(size = 8, face = "bold"),
    plot.margin      = margin(10, 10, 10, 10)
  )

# ──────────────────────────────────────────────────────────
# 8 · export
# ──────────────────────────────────────────────────────────
# ggsave("primate_phylogeny_superfamily.pdf", p, width = 9, height = 12, units = "in")
# ggsave("primate_phylogeny_superfamily.png", p, width = 9, height = 12, units = "in", dpi = 300)

print(p)
```


```{r test-stable}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}

tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · TREE panel with node labels
# ──────────────────────────────────────────────────────────
p <- ggtree(tree,
            layout    = "rectangular", 
            tip_order = ordered_tips,
            size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  # Add superfamily labels using panel-specific data
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3,
    fontface = "bold",
    hjust = 1.1,
    inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1,
    guide     = "none"  # Remove the superfamily legend
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# Add horizontal expansion to accommodate species names
p <- p + hexpand(.4, direction = 1)  # Expand to the right

# ──────────────────────────────────────────────────────────
# 5 · TRAITS panel (only dichromatism, dimorphism, natal)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

# Prepare trait data - with specific colors for each trait
trait_long <- tip_data %>%
  select(label, natal_coat, hair_dichromatism_any, hair_dimorphism) %>%
  mutate(
    Natal = ifelse(natal_coat == 1, 1, 0),
    Dichromatism = ifelse(hair_dichromatism_any == 1, 1, 0),  # Changed to 1
    Dimorphism = ifelse(hair_dimorphism == 1, 1, 0)           # Changed to 1
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(
    trait = factor(trait, levels = c("Natal", "Dichromatism", "Dimorphism")),
    trait_idx = as.numeric(trait),
    # Create color categories
    color_cat = case_when(
      trait == "Natal" & value == 1 ~ "Natal present",
      trait == "Dichromatism" & value == 1 ~ "Dichromatism present",
      trait == "Dimorphism" & value == 1 ~ "Dimorphism present",
      TRUE ~ "Absent"
    )
  )

# Define colors
trait_colors <- c(
  "Natal present" = "#2ECC71",         # Green
  "Dichromatism present" = "#E91E63",  # Pink
  "Dimorphism present" = "#3498DB",    # Blue
  "Absent" = "white"
)

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = trait_idx, fill = color_cat),
    width   = 0.8     # Consistent width for all tiles
  ) +
  scale_x_continuous(
    breaks = 1:3,
    limits = c(0.5, 3.5),
    expand = c(0, 0)
  ) +
  scale_fill_manual(
    values = trait_colors,
    name = "Traits",
    breaks = c("Natal present", "Dichromatism present", "Dimorphism present"),
    labels = c("Natal Coat", "Dichromatism", "Hair Dimorphism")
  ) +
  theme(
    axis.text.x = element_text(size = 6),
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 6 · PHOTO-count panel
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos,    0),
    GBIF_obs    = replace_na(gbif_photos,          0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count")

p <- facet_plot(
  p,
  panel        = "Photo counts",
  data         = photo_long,
  geom         = geom_col,
  mapping      = aes(x = count, fill = source),
  stat         = "identity",
  orientation  = "y",
  width        = 0.6
  ) +
  scale_x_log10(labels = label_number_auto()) +
  scale_fill_viridis_d(
    name   = "Source",
    option = "plasma",
    end    = .8,
    labels = c(
      iNaturalist = "iNaturalist",
      GBIF_obs    = "GBIF")
  ) +
  theme(
    axis.text.x = element_text(size = 6),
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank()
  ) 

# ──────────────────────────────────────────────────────────
# 7 · legend size  ← ADD THIS BLOCK
# ──────────────────────────────────────────────────────────
library(grid)                          # for unit()

p <- p +
  guides(
    Traits = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 1),
    Source = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 2)
  ) +
  theme(
    legend.key.size  = unit(.35, "cm"),   # shrink boxes
    legend.spacing.y = unit(.1,  "cm")    # tighten gaps
  )


# ──────────────────────────────────────────────────────────
# 7 · facet widths + global theme
# ──────────────────────────────────────────────────────────
p <- facet_widths(p, c(Tree = 2, Traits = 0.6, `Photo counts` = 1)) +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    # axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text      = element_text(size = 7),
    legend.title     = element_text(size = 8, face = "bold"),
    plot.margin      = margin(10, 10, 10, 10)
  )


# ──────────────────────────────────────────────────────────
# 8 · export
# ──────────────────────────────────────────────────────────
# ggsave("primate_phylogeny_superfamily.pdf", p, width = 9, height = 12, units = "in")
# ggsave("primate_phylogeny_superfamily.png", p, width = 9, height = 12, units = "in", dpi = 300)

print(p)
```

```{r test-almost}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# Define gibbon species keys
gibbon_keys <- c(
  "Nomascus leucogenys",
  "Hylobates pileatus",
  "Hylobates moloch",
  "Symphalangus syndactylus",
  "Hoolock hoolock"
)

data <- data %>%
  mutate(
    # Binary label for species with >100 combined photos
    inclusion = if_else(combined_photos > 100, "yes", "no"),
    
    # New dataset type column
    type_dataset = case_when(
      key %in% gibbon_keys ~ "gibbon",
      TRUE ~ type
    )
  )

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}


tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 1.5 · heatmap
# ──────────────────────────────────────────────────────────

# Prepare heatmap matrix (traits and categorical variables)
heatmap_data <- tip_data %>%
  select(label, 
         natal_coat, 
         hair_dichromatism_any, 
         hair_dimorphism, 
         type_dataset, 
         inclusion) %>%
  mutate(
    Natal        = ifelse(natal_coat == 1, "present", "absent"),
    Dichromatism = ifelse(hair_dichromatism_any == 1, "present", "absent"),
    Dimorphism   = ifelse(hair_dimorphism == 1, "present", "absent"),
    Dataset      = type_dataset,
    Included     = ifelse(inclusion == "yes", "Included", "Excluded")
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism, Dataset, Included)

# Set rownames = species label
heatmap_matrix <- heatmap_data %>%
  column_to_rownames("label")


# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · TREE panel with node labels
# ──────────────────────────────────────────────────────────
p <- ggtree(tree,
            layout    = "rectangular", 
            tip_order = ordered_tips,
            size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  # Add superfamily labels using panel-specific data
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3,
    fontface = "bold",
    hjust = 1.1,
    inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1,
    guide     = "none"  # Remove the superfamily legend
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# Add horizontal expansion to accommodate species names
p <- p + hexpand(.4, direction = 1)  # Expand to the right

# ──────────────────────────────────────────────────────────
# 5 · TRAITS panel – two independent colour scales
# ──────────────────────────────────────────────────────────
library(ggnewscale)

## 1. make two long tables --------------------------------
trait_bin <- tip_data %>%                           # PRESENT / ABSENT only
  select(label, natal_coat, hair_dichromatism_any, hair_dimorphism) %>%
  mutate(
    Natal        = if_else(natal_coat == 1,        "present", "absent"),
    Dichromatism = if_else(hair_dichromatism_any==1,"present","absent"),
    Dimorphism   = if_else(hair_dimorphism == 1,   "present", "absent")
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(trait = factor(trait,
                        levels = c("Natal","Dichromatism","Dimorphism")),
         x      = as.numeric(trait))                # x-pos 1-3

trait_cat <- tip_data %>%                           # DATASET / INCLUDED
  select(label, type_dataset, inclusion) %>%
  mutate(
    Dataset  = type_dataset,
    Included = if_else(inclusion == "yes", "Included", "Excluded")
  ) %>%
  select(label, Dataset, Included) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(trait = factor(trait, levels = c("Dataset","Included")),
         x      = as.numeric(trait) + 3)            # x-pos 4-5

## 2. add binary-trait tiles ------------------------------
p <- p + new_scale_fill()

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_bin,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1:5,
    labels = c("Natal","Dichro.","Dimorph.","Dataset","Included"),
    expand = c(0, 0)
  ) +
  scale_fill_manual(
    name   = "Presence",
    values = c(present = "#2ECC71", absent = "white")
  )

## 3. add new colour scale then categorical tiles ---------
p <- p + new_scale_fill()

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_cat,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1
  ) +
  scale_fill_manual(
    name   = "Category",
    values = c(
      focal      = "#F39C12",
      additional = "#8E44AD",
      gibbon     = "#1ABC9C",
      Included   = "#000000",
      Excluded   = "#BBBBBB"
    )
  )

## 4. tidy theme and panel width --------------------------
p <- p +
  theme(
    axis.text.x    = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x   = element_blank(),
    axis.ticks.x   = element_blank(),
    axis.line.x    = element_blank(),
    panel.spacing.x = unit(0, "cm")
  ) 

# ──────────────────────────────────────────────────────────
# 6 · PHOTO-count panel
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos,    0),
    GBIF_obs    = replace_na(gbif_photos,          0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count")

p <- facet_plot(
  p,
  panel        = "Photo counts",
  data         = photo_long,
  geom         = geom_col,
  mapping      = aes(x = count, fill = source),
  stat         = "identity",
  orientation  = "y",
  width        = 0.6
  ) +
  scale_x_log10(labels = label_number_auto()) +
  scale_fill_viridis_d(
    name   = "Source",
    option = "plasma",
    end    = .8,
    labels = c(
      iNaturalist = "iNaturalist",
      GBIF_obs    = "GBIF")
  ) +
  theme(
    axis.text.x = element_text(size = 6),
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank()
  ) 

# ──────────────────────────────────────────────────────────
# 7 · legend size  ← ADD THIS BLOCK
# ──────────────────────────────────────────────────────────
library(grid)                          # for unit()

p <- p +
  guides(
    Traits = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 1),
    Source = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 2)
  ) +
  theme(
    legend.key.size  = unit(.35, "cm"),   # shrink boxes
    legend.spacing.y = unit(.1,  "cm")    # tighten gaps
  )


# ──────────────────────────────────────────────────────────
# 7 · facet widths + global theme
# ──────────────────────────────────────────────────────────
## adjust column widths
p <- facet_widths(
        p,
        c(Tree = 2.2, Traits = 1.1, `Photo counts` = 1)
     )

## now add styling
p <- p +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text  = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    panel.spacing.x = unit(0, "cm"),
    plot.margin  = margin(10, 10, 10, 10)
  )+
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    # axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text      = element_text(size = 7),
    legend.title     = element_text(size = 8, face = "bold"),
    plot.margin      = margin(10, 10, 10, 10)
  )


# ──────────────────────────────────────────────────────────
# 8 · export
# ──────────────────────────────────────────────────────────
# ggsave("primate_phylogeny_superfamily.pdf", p, width = 9, height = 12, units = "in")
# ggsave("primate_phylogeny_superfamily.png", p, width = 9, height = 12, units = "in", dpi = 300)

print(p)
```

```{r test-stable-new}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# Define gibbon species keys
gibbon_keys <- c(
  "Nomascus leucogenys",
  "Hylobates pileatus",
  "Hylobates moloch",
  "Symphalangus syndactylus",
  "Hoolock hoolock"
)

data <- data %>%
  mutate(
    # Binary label for species with >100 combined photos
    inclusion = if_else(combined_photos > 100, "yes", "no"),
    
    # New dataset type column
    type_dataset = case_when(
      key %in% gibbon_keys ~ "gibbon",
      TRUE ~ type
    )
  )

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}


tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 1.5 · heatmap
# ──────────────────────────────────────────────────────────

# Prepare heatmap matrix (traits and categorical variables)
heatmap_data <- tip_data %>%
  select(label, 
         natal_coat, 
         hair_dichromatism_any, 
         hair_dimorphism, 
         type_dataset, 
         inclusion) %>%
  mutate(
    Natal        = ifelse(natal_coat == 1, "present", "absent"),
    Dichromatism = ifelse(hair_dichromatism_any == 1, "present", "absent"),
    Dimorphism   = ifelse(hair_dimorphism == 1, "present", "absent"),
    Dataset      = type_dataset,
    Included     = ifelse(inclusion == "yes", "Included", "Excluded")
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism, Dataset, Included)

# Set rownames = species label
heatmap_matrix <- heatmap_data %>%
  column_to_rownames("label")


# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · TREE panel with node labels
# ──────────────────────────────────────────────────────────
p <- ggtree(tree,
            layout    = "rectangular", 
            tip_order = ordered_tips,
            size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  # Add superfamily labels using panel-specific data
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3,
    fontface = "bold",
    hjust = 1.1,
    inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1,
    guide     = "none"  # Remove the superfamily legend
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# Add horizontal expansion to accommodate species names
p <- p + hexpand(.4, direction = 1)  # Expand to the right

# ──────────────────────────────────────────────────────────
# 5 · TRAITS panel (Natal, Dichromatism, Dimorphism)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

trait_long <- tip_data %>%
  select(label, natal_coat, hair_dichromatism_any, hair_dimorphism) %>%
  mutate(
    Natal        = if_else(natal_coat == 1,        1, 0),
    Dichromatism = if_else(hair_dichromatism_any==1,1, 0),
    Dimorphism   = if_else(hair_dimorphism == 1,    1, 0)
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(
    trait     = factor(trait, levels = c("Natal","Dichromatism","Dimorphism")),
    trait_idx = as.numeric(trait),
    color_cat = case_when(
      trait == "Natal"        & value == 1 ~ "Natal present",
      trait == "Dichromatism" & value == 1 ~ "Dichromatism present",
      trait == "Dimorphism"   & value == 1 ~ "Dimorphism present",
      TRUE ~ "Absent")
  )

trait_colors <- c(
  "Natal present"        = "#2ECC71",
  "Dichromatism present" = "#E91E63",
  "Dimorphism present"   = "#3498DB",
  "Absent"               = "white"
)

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = trait_idx, fill = color_cat),
    width   = 0.8
  ) +
  scale_x_continuous(
    breaks = 1:3,
    limits = c(0.5, 3.5),
    expand = c(0, 0)
  ) +
  scale_fill_manual(
    values = trait_colors,
    name   = "Traits",
    breaks = c("Natal present","Dichromatism present","Dimorphism present"),
    labels = c("Natal Coat","Dichromatism","Hair Dimorphism")
  ) +
  theme(
    axis.text.x  = element_text(size = 6),
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5b · DATASET panel (focal/additional/gibbon)
# ──────────────────────────────────────────────────────────
library(ggnewscale)          # make sure it's loaded

p <- p + new_scale_fill()    # start a second fill scale

dataset_long <- tip_data %>%
  select(label, type_dataset) %>%               # focal / additional / gibbon
  mutate(trait = "Dataset",                     # single column
         value = type_dataset,
         x     = 1)                             # one tile wide

dataset_colors <- c(
  focal      = "#F39C12",
  additional = "#8E44AD",
  gibbon     = "#1ABC9C"
)

p <- p +
  geom_facet(
    panel   = "Dataset",
    data    = dataset_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 0.8
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Dataset"
  ) +
  scale_fill_manual(
    values = dataset_colors,
    name   = "Dataset"
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )



# ──────────────────────────────────────────────────────────
# 6 · PHOTO-count panel
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos,    0),
    GBIF_obs    = replace_na(gbif_photos,          0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count")

p <- facet_plot(
  p,
  panel        = "Photo counts",
  data         = photo_long,
  geom         = geom_col,
  mapping      = aes(x = count, fill = source),
  stat         = "identity",
  orientation  = "y",
  width        = 0.6
  ) +
  scale_x_log10(labels = label_number_auto()) +
  scale_fill_viridis_d(
    name   = "Source",
    option = "plasma",
    end    = .8,
    labels = c(
      iNaturalist = "iNaturalist",
      GBIF_obs    = "GBIF")
  ) +
  theme(
    axis.text.x = element_text(size = 6),
    axis.title.x = element_text(size = 7, face = "bold"),
    axis.ticks.x = element_blank(),
    axis.line.x = element_blank()
  ) 

# ──────────────────────────────────────────────────────────
# 7 · legend size  ← ADD THIS BLOCK
# ──────────────────────────────────────────────────────────
library(grid)                          # for unit()

p <- p +
  guides(
    Traits = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 1),
    Source = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 2)
  ) +
  theme(
    legend.key.size  = unit(.35, "cm"),   # shrink boxes
    legend.spacing.y = unit(.1,  "cm")    # tighten gaps
  )


# ──────────────────────────────────────────────────────────
# 7 · facet widths + global theme
# ──────────────────────────────────────────────────────────
# ──────────────────────────────────────────────────────────
# 5c · update facet widths so panels line up
# ──────────────────────────────────────────────────────────
p <- facet_widths(
        p,
        c(Tree = 2.2, Traits = 1.1, Dataset = 0.6, `Photo counts` = 1.0)
     )

## now add styling
p <- p +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text  = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    panel.spacing.x = unit(0, "cm"),
    plot.margin  = margin(10, 10, 10, 10)
  )+
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    # axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text      = element_text(size = 7),
    legend.title     = element_text(size = 8, face = "bold"),
    plot.margin      = margin(10, 10, 10, 10)
  )


# ──────────────────────────────────────────────────────────
# 8 · export
# ──────────────────────────────────────────────────────────
# ggsave("primate_phylogeny_superfamily.pdf", p, width = 9, height = 12, units = "in")
# ggsave("primate_phylogeny_superfamily.png", p, width = 9, height = 12, units = "in", dpi = 300)

print(p)
```

```{r test}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# Define gibbon species keys
gibbon_keys <- c(
  "Nomascus leucogenys",
  "Hylobates pileatus",
  "Hylobates moloch",
  "Symphalangus syndactylus",
  "Hoolock hoolock"
)

data <- data %>%
  mutate(
    # Binary label for species with >100 combined photos
    inclusion = if_else(combined_photos > 100, "yes", "no"),
    
    # New dataset type column
    type_dataset = case_when(
      key %in% gibbon_keys ~ "gibbon",
      TRUE ~ type
    )
  )

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}


tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 1.5 · heatmap
# ──────────────────────────────────────────────────────────

# Prepare heatmap matrix (traits and categorical variables)
heatmap_data <- tip_data %>%
  select(label, 
         natal_coat, 
         hair_dichromatism_any, 
         hair_dimorphism, 
         type_dataset, 
         inclusion) %>%
  mutate(
    Natal        = ifelse(natal_coat == 1, "present", "absent"),
    Dichromatism = ifelse(hair_dichromatism_any == 1, "present", "absent"),
    Dimorphism   = ifelse(hair_dimorphism == 1, "present", "absent"),
    Dataset      = type_dataset,
    Included     = ifelse(inclusion == "yes", "Included", "Excluded")
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism, Dataset, Included)

# Set rownames = species label
heatmap_matrix <- heatmap_data %>%
  column_to_rownames("label")


# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · TREE panel with node labels
# ──────────────────────────────────────────────────────────
p <- ggtree(tree,
            layout    = "rectangular", 
            tip_order = ordered_tips,
            size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(
    size     = 1,
    align    = TRUE,
    linesize = .1,
    offset   = 0.02          # bump this up if labels touch the tips
  ) +
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3, fontface = "bold", hjust = 1.1, inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(option = "viridis", guide = "none") +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

p <- p + hexpand(.4, direction = 1)   # extra room for tip labels


# ──────────────────────────────────────────────────────────
# 5 · TRAITS panel  (Natal, Dichromatism, Dimorphism)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()                       # start 1st extra fill scale

trait_long <- tip_data %>%
  select(label, natal_coat, hair_dichromatism_any, hair_dimorphism) %>%
  mutate(
    Natal        = if_else(natal_coat == 1,         1, 0),
    Dichromatism = if_else(hair_dichromatism_any==1,1, 0),
    Dimorphism   = if_else(hair_dimorphism == 1,    1, 0)
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(
    trait     = factor(trait, levels = c("Natal","Dichromatism","Dimorphism")),
    x         = as.numeric(trait),
    color_cat = case_when(
      trait == "Natal"        & value == 1 ~ "Natal present",
      trait == "Dichromatism" & value == 1 ~ "Dichromatism present",
      trait == "Dimorphism"   & value == 1 ~ "Dimorphism present",
      TRUE ~ "Absent")
  )

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = color_cat),
    width   = 1,
    scales = "free_y"
  ) +
  scale_x_continuous(
    breaks = 1:3,
    limits = c(0.5, 3.5),
    expand = c(0, 0),
    labels = c("Natal","Dichro.","Dimorph.")
  ) +
  scale_fill_manual(
    name   = "Traits",
    values = c(
      "Natal present"        = "#2ECC71",
      "Dichromatism present" = "#E91E63",
      "Dimorphism present"   = "#3498DB",
      "Absent"               = "white"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5b · DATASET panel  (focal / additional / gibbon)
# ──────────────────────────────────────────────────────────
library(ggnewscale)
p <- p + new_scale_fill()                       # 2nd extra fill scale

dataset_long <- tip_data %>%
  select(label, type_dataset) %>%
  mutate(trait = "Dataset",
         value = type_dataset,
         x     = 1)

p <- p +
  geom_facet(
    panel   = "Dataset",
    data    = dataset_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1,
    scales = "free_y"
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Dataset"
  ) +
  scale_fill_manual(
    name   = "Dataset",
    values = c(
      focal      = "#F39C12",
      additional = "#8E44AD",
      gibbon     = "#1ABC9C"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5c · INCLUDED panel  (binary yes/no)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()                       # 3rd extra fill scale

included_long <- tip_data %>%
  select(label, inclusion) %>%
  mutate(trait = "Included",
         value = if_else(inclusion == "yes", "Included", "Excluded"),
         x     = 1)

p <- p +
  geom_facet(
    panel   = "Included",
    data    = included_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1,
    scales = "free_y"
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Included"
  ) +
  scale_fill_manual(
    name   = "Included",
    values = c(
      Included = "black",
      Excluded = "white"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )


# ──────────────────────────────────────────────────────────
# 6 · PHOTO-count panel   ← replace just this block
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos, 0),
    GBIF_obs    = replace_na(gbif_photos,       0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count") %>%
  mutate(count_log = log10(pmax(count, 1)))          # ← log-transform here

p <- facet_plot(
        p,
        panel   = "Photo counts",
        data    = photo_long,
        geom    = geom_col,
        mapping = aes(x = count_log, fill = source), # ← use count_log
        orientation = "y",
        width   = 0.6
     ) +
     scale_x_continuous(                             # ← linear axis
       name   = "Photo count (log\u2081\u2080)",
       breaks = log10(c(1, 10, 100, 1e3, 1e4, 1e5)),
       labels = c("1","10","100","1k","10k","100k"),
       expand = c(0, 0)
     ) +
     scale_fill_viridis_d(
       name   = "Source",
       option = "plasma",
       end    = .8,
       labels = c(iNaturalist = "iNaturalist",
                  GBIF_obs    = "GBIF")
     ) +
     theme(
       axis.text.x  = element_text(size = 6),
       axis.title.x = element_text(size = 7, face = "bold"),
       axis.ticks.x = element_blank(),
       axis.line.x  = element_blank()
     )

# ──────────────────────────────────────────────────────────
# 7 · legend size  ← ADD THIS BLOCK
# ──────────────────────────────────────────────────────────
library(grid)                          # for unit()

p <- p +
  guides(
    Traits = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 1),
    Source = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 2)
  ) +
  theme(
    legend.key.size  = unit(.35, "cm"),   # shrink boxes
    legend.spacing.y = unit(.1,  "cm")    # tighten gaps
  )


# ──────────────────────────────────────────────────────────
# 7 · facet widths + global theme
# ──────────────────────────────────────────────────────────
# ──────────────────────────────────────────────────────────
# 5d · facet widths  (add the new panel)
# ──────────────────────────────────────────────────────────
p <- facet_widths(
        p,
        c(Tree = 2.2,
          Traits = 1.1,
          Dataset = 0.8,
          Included = 0.6,
          `Photo counts` = 1.0)
     )

## now add styling
p <- p +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text  = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    panel.spacing.x = unit(0, "cm"),
    plot.margin  = margin(10, 10, 10, 10)
  )+
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    # axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text      = element_text(size = 7),
    legend.title     = element_text(size = 8, face = "bold"),
    plot.margin      = margin(10, 10, 10, 10)
  )


# ──────────────────────────────────────────────────────────
# 8 · export
# ──────────────────────────────────────────────────────────
# ggsave("primate_phylogeny_superfamily.pdf", p, width = 9, height = 12, units = "in")
# ggsave("primate_phylogeny_superfamily.png", p, width = 9, height = 12, units = "in", dpi = 300)

print(p)
```

```{r new-patchwork}
# ─────────────────────────────────────────────────────────
# libraries
# ─────────────────────────────────────────────────────────
library(ggtree)
library(ggplot2)           # patchwork ships with ggplot2 ≥ 3.4
library(dplyr)
library(tidyr)
library(viridis)
library(ggnewscale)

# ─────────────────────────────────────────────────────────
# 1 · import and preprocessing (same as before)
# ─────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

gibbon_keys <- c(
  "Nomascus leucogenys","Hylobates pileatus","Hylobates moloch",
  "Symphalangus syndactylus","Hoolock hoolock")

data <- data %>%
  mutate(inclusion    = if_else(combined_photos > 100, "yes", "no"),
         type_dataset = if_else(key %in% gibbon_keys, "gibbon", type))

# helper to reconcile names -------------------------------------------------
map_name <- function(x) gsub("_", " ", x)
lookup <- data %>% transmute(tree = species, data_name = species)
species_map <- setNames(lookup$data_name, lookup$tree)

# order tips once so every panel shares the y-axis --------------------------
tip_order <- tree$tip.label
species_factor <- factor(map_name(tip_order), levels = rev(map_name(tip_order)))

# ─────────────────────────────────────────────────────────
# 2 · panel 1  Tree
# ─────────────────────────────────────────────────────────
p_tree <- ggtree(tree, size = .3) +
  theme_tree2() +
  theme(plot.margin = margin(r = 2))            # tiny gap on the right

# ─────────────────────────────────────────────────────────
# 3 · panel 2  Traits heat-map (Natal, Dichromatism, Dimorphism)
# ─────────────────────────────────────────────────────────
trait_long <- data %>%
  filter(species %in% names(species_map)) %>%
  transmute(
    species     = map_name(species),
    Natal        = if_else(natal_coat == 1,        "present", "absent"),
    Dichromatism = if_else(hair_dichromatism_any==1,"present","absent"),
    Dimorphism   = if_else(hair_dimorphism == 1,    "present", "absent")
  ) %>%
  pivot_longer(-species, names_to = "trait", values_to = "value")

p_traits <- ggplot(trait_long,
                   aes(x = trait, y = factor(species, levels = species_factor),
                       fill = interaction(trait, value))) +
  geom_tile() +
  scale_fill_manual(
    values = c("Natal.present"        = "#2ECC71",
               "Dichromatism.present" = "#E91E63",
               "Dimorphism.present"   = "#3498DB",
               "Natal.absent"         = "white",
               "Dichromatism.absent"  = "white",
               "Dimorphism.absent"    = "white"),
    guide = "none"
  ) +
  scale_x_discrete(position = "top") +
  theme_void() +
  theme(axis.text.x = element_text(size = 6, angle = 90, vjust = 0.5))

# ─────────────────────────────────────────────────────────
# 4 · panel 3  Dataset type
# ─────────────────────────────────────────────────────────
p_dataset <- ggplot(data, aes(x = 1,
                              y = factor(map_name(species), levels = species_factor),
                              fill = type_dataset)) +
  geom_tile() +
  scale_fill_manual(values = c(focal = "#F39C12",
                               additional = "#8E44AD",
                               gibbon = "#1ABC9C"),
                    name   = "Dataset") +
  scale_x_continuous(expand = c(0, 0), breaks = NULL) +
  theme_void() +
  theme(legend.position = "right")

# ─────────────────────────────────────────────────────────
# 5 · panel 4  Included
# ─────────────────────────────────────────────────────────
p_included <- ggplot(data, aes(x = 1,
                               y = factor(map_name(species), levels = species_factor),
                               fill = inclusion)) +
  geom_tile() +
  scale_fill_manual(values = c(yes = "black", no = "white"),
                    name   = "Included",
                    breaks = c("yes","no"),
                    labels = c("Included","Excluded")) +
  scale_x_continuous(expand = c(0, 0), breaks = NULL) +
  theme_void() +
  theme(legend.position = "right")

# ─────────────────────────────────────────────────────────
# 6 · panel 5  Photo counts (log10)
# ─────────────────────────────────────────────────────────
photo_long <- data %>%
  filter(species %in% names(species_map)) %>%
  transmute(species = map_name(species),
            iNaturalist = replace_na(inat_total_photos, 0),
            GBIF_obs    = replace_na(gbif_photos,       0)) %>%
  pivot_longer(-species, names_to = "source", values_to = "count")

p_photo <- ggplot(photo_long,
                  aes(x = count, y = factor(species, levels = species_factor),
                      fill = source)) +
  geom_col(width = 0.6) +
  scale_x_log10(breaks = c(1, 10, 100, 1e3, 1e4, 1e5),
                labels = c("1","10","100","1k","10k","100k")) +
  scale_fill_viridis_d(name = "Source", option = "plasma", end = .8) +
  labs(x = "Photo count (log10)") +
  theme_void() +
  theme(axis.text.x  = element_text(size = 6),
        axis.title.x = element_text(size = 7, face = "bold"),
        legend.position = "right")

# ─────────────────────────────────────────────────────────
# 7 · assemble with patchwork
# ─────────────────────────────────────────────────────────
library(patchwork)

final_plot <- p_tree + p_traits + p_dataset + p_included + p_photo +
  plot_layout(ncol = 5, widths = c(2.2, 1.1, 0.8, 0.6, 1.0),
              guides = "collect") &
  theme(legend.key.size = unit(.35, "cm"),
        legend.text     = element_text(size = 7),
        legend.title    = element_text(size = 8, face = "bold"),
        plot.margin     = margin(5, 5, 5, 5))

# ─────────────────────────────────────────────────────────
# 8 · view or save
# ─────────────────────────────────────────────────────────
print(final_plot)
# ggsave("primate_phylogeny_panels.pdf", final_plot, width = 9, height = 12)


```

```{r test-claude-wronglog}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# Define gibbon species keys
gibbon_keys <- c(
  "Nomascus leucogenys",
  "Hylobates pileatus",
  "Hylobates moloch",
  "Symphalangus syndactylus",
  "Hoolock hoolock"
)

data <- data %>%
  mutate(
    # Binary label for species with >100 combined photos
    inclusion = if_else(combined_photos > 100, "yes", "no"),
    
    # New dataset type column
    type_dataset = case_when(
      key %in% gibbon_keys ~ "gibbon",
      TRUE ~ type
    )
  )

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}


tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 1.5 · heatmap
# ──────────────────────────────────────────────────────────

# Prepare heatmap matrix (traits and categorical variables)
heatmap_data <- tip_data %>%
  select(label, 
         natal_coat, 
         hair_dichromatism_any, 
         hair_dimorphism, 
         type_dataset, 
         inclusion) %>%
  mutate(
    Natal        = ifelse(natal_coat == 1, "present", "absent"),
    Dichromatism = ifelse(hair_dichromatism_any == 1, "present", "absent"),
    Dimorphism   = ifelse(hair_dimorphism == 1, "present", "absent"),
    Dataset      = type_dataset,
    Included     = ifelse(inclusion == "yes", "Included", "Excluded")
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism, Dataset, Included)

# Set rownames = species label
heatmap_matrix <- heatmap_data %>%
  column_to_rownames("label")


# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · TREE panel with node labels (NO hexpand!)
# ──────────────────────────────────────────────────────────
p <- ggtree(tree,
            layout    = "rectangular", 
            tip_order = ordered_tips,
            size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  # Add superfamily labels using panel-specific data
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3,
    fontface = "bold",
    hjust = 1.1,
    inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1,
    guide     = "none"  # Remove the superfamily legend
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# NO hexpand here! We'll use wider Tree panel instead

# ──────────────────────────────────────────────────────────
# 5 · TRAITS panel  (Natal, Dichromatism, Dimorphism)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()                       # start 1st extra fill scale

trait_long <- tip_data %>%
  select(label, natal_coat, hair_dichromatism_any, hair_dimorphism) %>%
  mutate(
    Natal        = if_else(natal_coat == 1,         1, 0),
    Dichromatism = if_else(hair_dichromatism_any==1,1, 0),
    Dimorphism   = if_else(hair_dimorphism == 1,    1, 0)
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(
    trait     = factor(trait, levels = c("Natal","Dichromatism","Dimorphism")),
    x         = as.numeric(trait),
    color_cat = case_when(
      trait == "Natal"        & value == 1 ~ "Natal present",
      trait == "Dichromatism" & value == 1 ~ "Dichromatism present",
      trait == "Dimorphism"   & value == 1 ~ "Dimorphism present",
      TRUE ~ "Absent")
  )

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = color_cat),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1:3,
    limits = c(0.5, 3.5),
    expand = c(0, 0),
    labels = c("Natal","Dichro.","Dimorph.")
  ) +
  scale_fill_manual(
    name   = "Traits",
    values = c(
      "Natal present"        = "#2ECC71",
      "Dichromatism present" = "#E91E63",
      "Dimorphism present"   = "#3498DB",
      "Absent"               = "white"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5b · DATASET panel  (focal / additional / gibbon)
# ──────────────────────────────────────────────────────────
library(ggnewscale)
p <- p + new_scale_fill()                       # 2nd extra fill scale

dataset_long <- tip_data %>%
  select(label, type_dataset) %>%
  mutate(trait = "Dataset",
         value = type_dataset,
         x     = 1)

p <- p +
  geom_facet(
    panel   = "Dataset",
    data    = dataset_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Dataset"
  ) +
  scale_fill_manual(
    name   = "Dataset",
    values = c(
      focal      = "#F39C12",
      additional = "#8E44AD",
      gibbon     = "#1ABC9C"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5c · INCLUDED panel  (binary yes/no)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()                       # 3rd extra fill scale

included_long <- tip_data %>%
  select(label, inclusion) %>%
  mutate(trait = "Included",
         value = if_else(inclusion == "yes", "Included", "Excluded"),
         x     = 1)

p <- p +
  geom_facet(
    panel   = "Included",
    data    = included_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Included"
  ) +
  scale_fill_manual(
    name   = "Included",
    values = c(
      Included = "black",
      Excluded = "white"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )


# ──────────────────────────────────────────────────────────
# 6 · PHOTO-count panel  (log bars) - FIXED VERSION
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos, 0),
    GBIF_obs    = replace_na(gbif_photos,       0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count") %>%
  # Pre-transform to log scale
  mutate(
    count_log = case_when(
      count == 0 ~ -0.5,  # Place zeros slightly below 0 for visibility
      TRUE ~ log10(count)
    )
  )

p <- facet_plot(
        p,
        panel   = "Photo counts",
        data    = photo_long,
        geom    = geom_col,
        mapping = aes(x = count_log, fill = source),  # Use pre-logged values
        orientation = "y",
        width   = 0.6,
        scales  = "free_x"          # panel gets its own x-axis
     ) +
     scale_fill_viridis_d(
       name   = "Source",
       option = "plasma",
       end    = .8,
       labels = c(iNaturalist = "iNaturalist",
                  GBIF_obs    = "GBIF")
     ) +
     # Use regular continuous scale with custom breaks/labels
     scale_x_continuous(
       name   = "Photo count (log10)",
       breaks = c(0, 1, 2, 3, 4, 5),
       labels = c("1", "10", "100", "1k", "10k", "100k"),
       limits = c(-0.5, 5.5),
       expand = c(0, 0)
     ) +
     theme(
       axis.text.x  = element_text(size = 6),
       axis.title.x = element_text(size = 7, face = "bold"),
       axis.ticks.x = element_blank(),
       axis.line.x  = element_blank()
     )

# Reset x-scale for tree and other panels - CRITICAL!
p <- p + scale_x_ggtree()

# ──────────────────────────────────────────────────────────
# 7 · legend size
# ──────────────────────────────────────────────────────────
library(grid)                          # for unit()

p <- p +
  guides(
    Traits = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 1),
    Source = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 2)
  ) +
  theme(
    legend.key.size  = unit(.35, "cm"),   # shrink boxes
    legend.spacing.y = unit(.1,  "cm")    # tighten gaps
  )


# ──────────────────────────────────────────────────────────
# 8 · facet widths + global theme
# ──────────────────────────────────────────────────────────
p <- facet_widths(
        p,
        c(Tree = 3.5,           # Increased from 2.2 to accommodate names
          Traits = 1.1,
          Dataset = 0.8,
          Included = 0.6,
          `Photo counts` = 1.0)
     )

## now add styling
p <- p +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text  = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    panel.spacing.x = unit(0, "cm"),
    plot.margin  = margin(10, 10, 10, 10)
  )+
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    # axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text      = element_text(size = 7),
    legend.title     = element_text(size = 8, face = "bold"),
    plot.margin      = margin(10, 10, 10, 10)
  )


# ──────────────────────────────────────────────────────────
# 9 · export
# ──────────────────────────────────────────────────────────
# ggsave("primate_phylogeny_superfamily.pdf", p, width = 9, height = 12, units = "in")
# ggsave("primate_phylogeny_superfamily.png", p, width = 9, height = 12, units = "in", dpi = 300)

print(p)
```


```{r test-claude-stable}

## issue is the x-axis notations and not enough species name space. 
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# Define gibbon species keys
gibbon_keys <- c(
  "Nomascus leucogenys",
  "Hylobates pileatus",
  "Hylobates moloch",
  "Symphalangus syndactylus",
  "Hoolock hoolock"
)

data <- data %>%
  mutate(
    # Binary label for species with >100 combined photos
    inclusion = if_else(combined_photos > 100, "yes", "no"),
    
    # New dataset type column
    type_dataset = case_when(
      key %in% gibbon_keys ~ "gibbon",
      TRUE ~ type
    )
  )

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}


tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 1.5 · heatmap
# ──────────────────────────────────────────────────────────

# Prepare heatmap matrix (traits and categorical variables)
heatmap_data <- tip_data %>%
  select(label, 
         natal_coat, 
         hair_dichromatism_any, 
         hair_dimorphism, 
         type_dataset, 
         inclusion) %>%
  mutate(
    Natal        = ifelse(natal_coat == 1, "present", "absent"),
    Dichromatism = ifelse(hair_dichromatism_any == 1, "present", "absent"),
    Dimorphism   = ifelse(hair_dimorphism == 1, "present", "absent"),
    Dataset      = type_dataset,
    Included     = ifelse(inclusion == "yes", "Included", "Excluded")
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism, Dataset, Included)

# Set rownames = species label
heatmap_matrix <- heatmap_data %>%
  column_to_rownames("label")


# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · TREE panel with node labels (NO hexpand!)
# ──────────────────────────────────────────────────────────
p <- ggtree(tree,
            layout    = "rectangular", 
            tip_order = ordered_tips,
            size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  # Add superfamily labels using panel-specific data
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3,
    fontface = "bold",
    hjust = 1.1,
    inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1,
    guide     = "none"  # Remove the superfamily legend
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# NO hexpand here! We'll use wider Tree panel instead

# ──────────────────────────────────────────────────────────
# 5 · TRAITS panel  (Natal, Dichromatism, Dimorphism)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()                       # start 1st extra fill scale

trait_long <- tip_data %>%
  select(label, natal_coat, hair_dichromatism_any, hair_dimorphism) %>%
  mutate(
    Natal        = if_else(natal_coat == 1,         1, 0),
    Dichromatism = if_else(hair_dichromatism_any==1,1, 0),
    Dimorphism   = if_else(hair_dimorphism == 1,    1, 0)
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(
    trait     = factor(trait, levels = c("Natal","Dichromatism","Dimorphism")),
    x         = as.numeric(trait),
    color_cat = case_when(
      trait == "Natal"        & value == 1 ~ "Natal present",
      trait == "Dichromatism" & value == 1 ~ "Dichromatism present",
      trait == "Dimorphism"   & value == 1 ~ "Dimorphism present",
      TRUE ~ "Absent")
  )

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = color_cat),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1:3,
    limits = c(0.5, 3.5),
    expand = c(0, 0),
    labels = c("Natal","Dichro.","Dimorph.")
  ) +
  scale_fill_manual(
    name   = "Traits",
    values = c(
      "Natal present"        = "#2ECC71",
      "Dichromatism present" = "#E91E63",
      "Dimorphism present"   = "#3498DB",
      "Absent"               = "white"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5b · DATASET panel  (focal / additional / gibbon)
# ──────────────────────────────────────────────────────────
library(ggnewscale)
p <- p + new_scale_fill()                       # 2nd extra fill scale

dataset_long <- tip_data %>%
  select(label, type_dataset) %>%
  mutate(trait = "Dataset",
         value = type_dataset,
         x     = 1)

p <- p +
  geom_facet(
    panel   = "Dataset",
    data    = dataset_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Dataset"
  ) +
  scale_fill_manual(
    name   = "Dataset",
    values = c(
      focal      = "#F39C12",
      additional = "#8E44AD",
      gibbon     = "#1ABC9C"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5c · INCLUDED panel  (binary yes/no)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()                       # 3rd extra fill scale

included_long <- tip_data %>%
  select(label, inclusion) %>%
  mutate(trait = "Included",
         value = if_else(inclusion == "yes", "Included", "Excluded"),
         x     = 1)

p <- p +
  geom_facet(
    panel   = "Included",
    data    = included_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Included"
  ) +
  scale_fill_manual(
    name   = "Included",
    values = c(
      Included = "black",
      Excluded = "white"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )


# Alternative approach for section 6 - handles zeros more elegantly
# ──────────────────────────────────────────────────────────
# 6 · PHOTO-count panel (with pseudo-log scale)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos, 0),
    GBIF_obs    = replace_na(gbif_photos,       0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count") %>%
  # Use a pseudo-log transformation (handles zeros naturally)
  mutate(
    count_transform = case_when(
      count == 0 ~ 0,
      count <= 10 ~ count / 10,  # Linear scale for small values
      TRUE ~ 1 + log10(count)    # Log scale for larger values
    )
  )

p <- facet_plot(
        p,
        panel   = "Photo counts",
        data    = photo_long,
        geom    = geom_col,
        mapping = aes(x = count_transform, fill = source),
        orientation = "y",
        width   = 0.6,
        scales  = "free_x"
     ) +
     scale_fill_viridis_d(
       name   = "Source",
       option = "plasma",
       end    = .8,
       labels = c(iNaturalist = "iNaturalist",
                  GBIF_obs    = "GBIF")
     ) +
     scale_x_continuous(
       name   = "Photo count",
       breaks = c(0, 0.5, 1, 2, 3, 4, 5, 6),
       labels = c("0", "5", "10", "100", "1k", "10k", "100k", "1M"),
       limits = c(0, 6.2),
       expand = c(0, 0)
     ) +
     theme(
       axis.text.x  = element_text(size = 6, angle = 45, hjust = 1),
       axis.title.x = element_text(size = 7, face = "bold"),
       axis.ticks.x = element_blank(),
       axis.line.x  = element_blank()
     )

# Reset x-scale for tree and other panels
p <- p + scale_x_ggtree()
# ──────────────────────────────────────────────────────────
# 7 · legend size
# ──────────────────────────────────────────────────────────
library(grid)                          # for unit()

p <- p +
  guides(
    Traits = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 1),
    Source = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 2)
  ) +
  theme(
    legend.key.size  = unit(.35, "cm"),   # shrink boxes
    legend.spacing.y = unit(.1,  "cm")    # tighten gaps
  )


# ──────────────────────────────────────────────────────────
# 8 · facet widths + global theme
# ──────────────────────────────────────────────────────────
p <- facet_widths(
        p,
        c(Tree = 3.5,           # Increased from 2.2 to accommodate names
          Traits = 1.1,
          Dataset = 0.8,
          Included = 0.6,
          `Photo counts` = 1.0)
     )

## now add styling
p <- p +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text  = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    panel.spacing.x = unit(0, "cm"),
    plot.margin  = margin(10, 10, 10, 10)
  )+
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    # axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text      = element_text(size = 7),
    legend.title     = element_text(size = 8, face = "bold"),
    plot.margin      = margin(10, 10, 10, 10)
  )


# ──────────────────────────────────────────────────────────
# 9 · export
# ──────────────────────────────────────────────────────────
ggsave("primate_phylogeny_superfamily2.pdf", p, width = 9, height = 12, units = "in")
ggsave("primate_phylogeny_superfamily2.png", p, width = 9, height = 12, units = "in", dpi = 300)

print(p)
```

```{r claude-stable-short}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
tree <- read.nexus("data/updated_pruned_tree.nex")
data <- read.csv("data/primate_prelim_complete.csv")

# Define gibbon species keys
gibbon_keys <- c(
  "Nomascus leucogenys",
  "Hylobates pileatus",
  "Hylobates moloch",
  "Symphalangus syndactylus",
  "Hoolock hoolock"
)

data <- data %>%
  mutate(
    # Binary label for species with >100 combined photos
    inclusion = if_else(combined_photos > 100, "yes", "no"),
    
    # New dataset type column
    type_dataset = case_when(
      key %in% gibbon_keys ~ "gibbon",
      TRUE ~ type
    )
  )

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}


tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 1.5 · heatmap
# ──────────────────────────────────────────────────────────

# Prepare heatmap matrix (traits and categorical variables)
heatmap_data <- tip_data %>%
  select(label, 
         natal_coat, 
         hair_dichromatism_any, 
         hair_dimorphism, 
         type_dataset, 
         inclusion) %>%
  mutate(
    Natal        = ifelse(natal_coat == 1, "present", "absent"),
    Dichromatism = ifelse(hair_dichromatism_any == 1, "present", "absent"),
    Dimorphism   = ifelse(hair_dimorphism == 1, "present", "absent"),
    Dataset      = type_dataset,
    Included     = ifelse(inclusion == "yes", "Included", "Excluded")
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism, Dataset, Included)

# Set rownames = species label
heatmap_matrix <- heatmap_data %>%
  column_to_rownames("label")


# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · TREE panel with node labels
# ──────────────────────────────────────────────────────────
p <- ggtree(tree,
            layout    = "rectangular", 
            tip_order = ordered_tips,
            size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3,
    fontface = "bold",
    hjust = 1.1,
    inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1,
    guide     = "none"
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# Add hexpand for tree labels
p <- p + hexpand(.6, direction = 1)  # Increased for more space

# ──────────────────────────────────────────────────────────
# 5 · TRAITS panel  (Natal, Dichromatism, Dimorphism)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

trait_long <- tip_data %>%
  select(label, natal_coat, hair_dichromatism_any, hair_dimorphism) %>%
  mutate(
    Natal        = if_else(natal_coat == 1,         1, 0),
    Dichromatism = if_else(hair_dichromatism_any==1,1, 0),
    Dimorphism   = if_else(hair_dimorphism == 1,    1, 0)
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(
    trait     = factor(trait, levels = c("Natal","Dichromatism","Dimorphism")),
    x         = as.numeric(trait),
    color_cat = case_when(
      trait == "Natal"        & value == 1 ~ "Natal present",
      trait == "Dichromatism" & value == 1 ~ "Dichromatism present",
      trait == "Dimorphism"   & value == 1 ~ "Dimorphism present",
      TRUE ~ "Absent")
  )

p <- p +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = color_cat),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1:3,
    limits = c(0.5, 3.5),
    expand = c(0, 0),
    labels = c("Natal","Dichro.","Dimorph.")
  ) +
  scale_fill_manual(
    name   = "Traits",
    values = c(
      "Natal present"        = "#2ECC71",
      "Dichromatism present" = "#E91E63",
      "Dimorphism present"   = "#3498DB",
      "Absent"               = "white"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5b · DATASET panel  (focal / additional / gibbon)
# ──────────────────────────────────────────────────────────
library(ggnewscale)
p <- p + new_scale_fill()

dataset_long <- tip_data %>%
  select(label, type_dataset) %>%
  mutate(trait = "Dataset",
         value = type_dataset,
         x     = 1)

p <- p +
  geom_facet(
    panel   = "Dataset",
    data    = dataset_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Dataset"
  ) +
  scale_fill_manual(
    name   = "Dataset",
    values = c(
      focal      = "#F39C12",
      additional = "#8E44AD",
      gibbon     = "#1ABC9C"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5c · INCLUDED panel  (binary yes/no)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

included_long <- tip_data %>%
  select(label, inclusion) %>%
  mutate(trait = "Included",
         value = if_else(inclusion == "yes", "Included", "Excluded"),
         x     = 1)

p <- p +
  geom_facet(
    panel   = "Included",
    data    = included_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Included"
  ) +
  scale_fill_manual(
    name   = "Included",
    values = c(
      Included = "black",
      Excluded = "white"
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# RESET SCALE BEFORE PHOTO PANEL - THIS IS CRITICAL
# ──────────────────────────────────────────────────────────
p <- p + scale_x_ggtree()

# ──────────────────────────────────────────────────────────
# 6 · PHOTO-count panel (standard log scale)
# ──────────────────────────────────────────────────────────
p <- p + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos, 0),
    GBIF_obs    = replace_na(gbif_photos,       0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count") %>%
  # Remove zeros for log scale
  filter(count > 0)

p <- facet_plot(
        p,
        panel   = "Photo counts",
        data    = photo_long,
        geom    = geom_col,
        mapping = aes(x = count, fill = source),
        orientation = "y",
        width   = 0.6,
        scales  = "free_x"  # This ensures independent x-axis
     )

# Apply log scale AFTER facet_plot
p <- p +
     scale_x_log10(
       name   = "Photo count (log10)",
       breaks = c(1, 10, 100, 1000, 10000, 100000),
       labels = c("1", "10", "100", "1k", "10k", "100k"),
       expand = c(0, 0)
     ) +
     scale_fill_viridis_d(
       name   = "Source",
       option = "plasma",
       end    = .8,
       labels = c(iNaturalist = "iNaturalist",
                  GBIF_obs    = "GBIF")
     ) +
     theme(
       axis.text.x  = element_text(size = 6),
       axis.title.x = element_text(size = 7, face = "bold"),
       axis.ticks.x = element_blank(),
       axis.line.x  = element_blank()
     )

# ──────────────────────────────────────────────────────────
# 7 · legend size
# ──────────────────────────────────────────────────────────
library(grid)

p <- p +
  guides(
    Traits = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 1),
    Source = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 2)
  ) +
  theme(
    legend.key.size  = unit(.35, "cm"),
    legend.spacing.y = unit(.1,  "cm")
  )

# ──────────────────────────────────────────────────────────
# 8 · facet widths
# ──────────────────────────────────────────────────────────
p <- facet_widths(
        p,
        c(Tree = 2,           # Wider tree panel
          Traits = 0.6,         # Narrower
          Dataset = 0.2,        # Much narrower
          Included = 0.2,       # Much narrower
          `Photo counts` = 1.0)
     )

# Apply theme
p <- p +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text  = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    panel.spacing.x = unit(0, "cm"),
    plot.margin  = margin(10, 10, 10, 10)
  )

# ──────────────────────────────────────────────────────────
# 9 · export
# ──────────────────────────────────────────────────────────
print(p)

# ──────────────────────────────────────────────────────────
# 8 · export
# ──────────────────────────────────────────────────────────
ggsave("primate_phylogeny_superfamily.pdf", p, width = 9, height = 11, units = "in")
ggsave("primate_phylogeny_superfamily.png", p, width = 9, height = 11, units = "in", dpi = 300)

```

```{r functional-final}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels

# ──────────────────────────────────────────────────────────
# 1 · read tree & data
# ──────────────────────────────────────────────────────────
# tree <- read.nexus("data/updated_pruned_tree.nex")
# data <- read.csv("data/primate_prelim_complete.csv")
# 
# # Define gibbon species keys
# gibbon_keys <- c(
#   "Nomascus leucogenys",
#   "Hylobates pileatus",
#   "Hylobates moloch",
#   "Symphalangus syndactylus",
#   "Hoolock hoolock"
# )
# 
# data <- data %>%
#   mutate(
#     # Binary label for species with >100 combined photos
#     inclusion = if_else(combined_photos >= 100, "yes", "no"),
#     
#     # New dataset type column
#     type_dataset = case_when(
#       key %in% gibbon_keys ~ "gibbon",
#       TRUE ~ type
#     )
#   )

data <- df_tagged

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}

tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 1.5 · heatmap
# ──────────────────────────────────────────────────────────

# Prepare heatmap matrix (traits and categorical variables)
heatmap_data <- tip_data %>%
  select(label, 
         natal_coat, 
         hair_dichromatism_any, 
         hair_dimorphism, 
         type_dataset, 
         inclusion) %>%
  mutate(
    Natal        = ifelse(natal_coat == 1, "present", "absent"),
    Dichromatism = ifelse(hair_dichromatism_any == 1, "present", "absent"),
    Dimorphism   = ifelse(hair_dimorphism == 1, "present", "absent"),
    Dataset      = type_dataset,
    Included     = ifelse(inclusion == "yes", "Included", "Excluded")
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism, Dataset, Included)

# Set rownames = species label
heatmap_matrix <- heatmap_data %>%
  column_to_rownames("label")

# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · BUILD BASE TREE PANEL
# ──────────────────────────────────────────────────────────
p_tree_base <- ggtree(tree,
                      layout    = "rectangular", 
                      # tip_order = ordered_tips,
                      size      = .3) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3,
    fontface = "bold",
    hjust = 1.1,
    inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1,
    guide     = "none"
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# Add hexpand to tree
p_tree_expanded <- p_tree_base + hexpand(.6, direction = 1)

# ──────────────────────────────────────────────────────────
# 5 · ADD TRAITS PANEL
# ──────────────────────────────────────────────────────────
p_with_traits <- p_tree_expanded + new_scale_fill()

trait_long <- tip_data %>%
  select(label, natal_coat, hair_dichromatism_any, hair_dimorphism) %>%
  mutate(
    Natal        = if_else(natal_coat == 1,         1, 0),
    Dichromatism = if_else(hair_dichromatism_any==1,1, 0),
    Dimorphism   = if_else(hair_dimorphism == 1,    1, 0)
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism) %>%
  pivot_longer(-label, names_to = "trait", values_to = "value") %>%
  mutate(
    trait     = factor(trait, levels = c("Natal","Dichromatism","Dimorphism")),
    x         = as.numeric(trait),
    # Updated labels without "present"
    color_cat = case_when(
      trait == "Natal"        & value == 1 ~ "Natal",
      trait == "Dichromatism" & value == 1 ~ "Dichromatism",
      trait == "Dimorphism"   & value == 1 ~ "Dimorphism",
      TRUE ~ "Absent")
  )

p_with_traits <- p_with_traits +
  geom_facet(
    panel   = "Traits",
    data    = trait_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = color_cat),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1:3,
    limits = c(0.5, 3.5),
    expand = c(0, 0),
    labels = c("Natal","Dichro.","Dimorph.")
  ) +
  scale_fill_manual(
    name   = "Traits",
    values = c(
      "Natal"        = "#2ECC71",
      "Dichromatism" = "#E91E63",
      "Dimorphism"   = "#3498DB",
      "Absent"       = "white"
    ),
    # Remove "Absent" from legend
    breaks = c("Natal", "Dichromatism", "Dimorphism")
  ) +
  theme(
    axis.text.x  = element_text(size = 6),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5b · ADD DATASET PANEL (with viridis colors)
# ──────────────────────────────────────────────────────────
p_with_dataset <- p_with_traits + new_scale_fill()

dataset_long <- tip_data %>%
  select(label, type_dataset) %>%
  mutate(trait = "Dataset",
         value = type_dataset,
         x     = 1)

# Get viridis colors for the three categories
viridis_colors <- viridis(3, begin = 0.2, end = 0.8)

p_with_dataset <- p_with_dataset +
  geom_facet(
    panel   = "Dataset",
    data    = dataset_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Dataset"
  ) +
  scale_fill_manual(
    name   = "Dataset",
    values = c(
      focal      = viridis_colors[1],
      additional = viridis_colors[2],
      gibbon     = viridis_colors[3]
    )
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 5c · ADD INCLUDED PANEL
# ──────────────────────────────────────────────────────────
p_with_included <- p_with_dataset + new_scale_fill()

included_long <- tip_data %>%
  select(label, inclusion) %>%
  mutate(trait = "Included",
         value = if_else(inclusion == "yes", "Included", "Excluded"),
         x     = 1)

p_with_included <- p_with_included +
  geom_facet(
    panel   = "Included",
    data    = included_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = value),
    width   = 1
  ) +
  scale_x_continuous(
    breaks = 1,
    limits = c(0.5, 1.5),
    expand = c(0, 0),
    labels = "Included"
  ) +
  scale_fill_manual(
    name   = "Included",
    values = c(
      Included = "black",
      Excluded = "white"
    ),
    # Remove "Excluded" from legend
    breaks = c("Included")
  ) +
  theme(
    axis.text.x  = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# CRITICAL: RESET SCALE BEFORE PHOTO PANEL
# ──────────────────────────────────────────────────────────
p_reset_scale <- p_with_included + scale_x_ggtree()

# ──────────────────────────────────────────────────────────
# 6 · ADD PHOTO PANEL (with vline at 100)
# ──────────────────────────────────────────────────────────
p_with_photo <- p_reset_scale + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos, 0),
    GBIF_obs    = replace_na(gbif_photos,       0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count") %>%
  filter(count > 0)  # Remove zeros for log scale

# Data for vertical line at 100
vline_data <- data.frame(
  x = 100,
  .panel = "Photo counts"
)

p_with_photo <- facet_plot(
        p_with_photo,
        panel   = "Photo counts",
        data    = photo_long,
        geom    = geom_col,
        mapping = aes(x = count, fill = source),
        orientation = "y",
        width   = 0.6,
        scales  = "free_x"
     )

# # Add vertical line at 100
# p_with_photo <- p_with_photo +
#   geom_vline(
#     data = vline_data,
#     aes(xintercept = x),
#     linetype = "dashed",
#     color = "gray50",
#     size = 0.5
#   )

# Apply log scale and theme
p_with_photo <- p_with_photo +
     scale_x_log10(
       name   = "Photo count (log10)",
       breaks = c(1, 10, 100, 1000, 10000, 100000),
       labels = c("1", "10", "100", "1k", "10k", "100k"),
       expand = c(0, 0)
     ) +
     scale_fill_viridis_d(
       name   = "Source",
       option = "plasma",
       end    = .8,
       labels = c(iNaturalist = "iNaturalist",
                  GBIF_obs    = "GBIF")
     ) +
     theme(
       axis.text.x  = element_text(size = 6),
       axis.title.x = element_text(size = 7, face = "bold"),
       axis.ticks.x = element_blank(),
       axis.line.x  = element_blank()
     )

# ──────────────────────────────────────────────────────────
# 7 · FINALIZE: Add legend formatting
# ──────────────────────────────────────────────────────────
library(grid)

p_final <- p_with_photo +
  guides(
    Traits = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 1),
    Source = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 2)
  ) +
  theme(
    legend.key.size  = unit(.35, "cm"),
    legend.spacing.y = unit(.1,  "cm")
  )

# ──────────────────────────────────────────────────────────
# 8 · Set facet widths
# ──────────────────────────────────────────────────────────
p_final <- facet_widths(
        p_final,
        c(Tree = 2,
          Traits = 1,
          Dataset = 0.5,
          Included = 0.5,
          `Photo counts` = 1.0)
     )

# Apply final theme
p_final <- p_final +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text  = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    panel.spacing.x = unit(0, "cm"),
    plot.margin  = margin(10, 10, 10, 10)
  )

# ──────────────────────────────────────────────────────────
# 9 · Export
# ──────────────────────────────────────────────────────────
ggsave("primate_phylogeny_superfamily_final.pdf", p_final, width = 11, height = 15, units = "in")
ggsave("primate_phylogeny_superfamily_final.png", p_final, width = 11, height = 15, units = "in", dpi = 500)

print(p_final)
```


```{r functional-simple-finalv2}
# ──────────────────────────────────────────────────────────
# 0 · libraries
# ──────────────────────────────────────────────────────────
library(ggtree)          # ≥ 3.8
library(ggtreeExtra)     # facet_plot / geom_fruit helpers
library(ggplot2)
library(ggnewscale)
library(dplyr)
library(tidyr)
library(tibble)
library(ape)
library(viridis)
library(purrr)
library(scales)          # nice comma labels


# ---- 1 · Dataset colours (3 equally spaced on plasma, no bright yellow) ----
dataset_cols <- viridis(9, option = "plasma")[c(6, 9, 1)]
names(dataset_cols) <- c("focal", "gibbon", "additional")
#   focal      → deep violet
#   gibbon     → rich magenta
#   additional → warm orange-gold

# ---- 2 · Photo-source colours (2 darker blues from mako) ----
photo_cols <- mako(6)[c(2, 5)]
names(photo_cols) <- c("iNaturalist", "GBIF_obs")
#   iNaturalist → navy-blue
#   GBIF_obs    → steel-blue

# ──────────────────────────────────────────────────────────
data <- df_tagged

data_all_names <- distinct(data, species, inat_name, species_binom, key)

flex_match <- function(tree_sp, df) {
  hit <- df$species[
    df$species       == tree_sp |
      df$inat_name   == tree_sp |
      df$species_binom == tree_sp |
      df$key         == tree_sp
  ]
  if (length(hit)) return(hit[1])

  parts <- strsplit(tree_sp, " ")[[1]]
  if (length(parts) == 2 && parts[1] == "Callicebus") {
    ep  <- parts[2]
    hit <- df$species[grepl(paste0("^Plecturocebus ", ep, "$"), df$species)]
    if (length(hit)) return(hit[1])
  }

  special <- c(
    `Trachypithecus johnii` = "Semnopithecus johnii",
    `Cercopithecus preussi` = "Allochrocebus preussi",
    `Oreonax flavicauda`    = "Lagothrix flavicauda",
    `Lagothrix lagotricha`  = "Lagothrix lagothricha"
  )
  if (tree_sp %in% names(special) && special[[tree_sp]] %in% df$species)
    return(special[[tree_sp]])

  NA_character_
}

tip_data <- tibble(label = tree$tip.label,
                   tree_species = gsub("_", " ", tree$tip.label)) %>%
  mutate(data_species = sapply(tree_species, flex_match, df = data_all_names)) %>%
  left_join(data, by = c("data_species" = "species")) %>%
  mutate(family = coalesce(family, family_trait))

# ──────────────────────────────────────────────────────────
# 1.5 · heatmap
# ──────────────────────────────────────────────────────────

# Prepare heatmap matrix (traits and categorical variables)
heatmap_data <- tip_data %>%
  select(label, 
         natal_coat, 
         hair_dichromatism_any, 
         hair_dimorphism, 
         type_dataset, 
         inclusion) %>%
  mutate(
    Natal        = ifelse(natal_coat == 1, "present", "absent"),
    Dichromatism = ifelse(hair_dichromatism_any == 1, "present", "absent"),
    Dimorphism   = ifelse(hair_dimorphism == 1, "present", "absent"),
    Dataset      = type_dataset,
    Included     = ifelse(inclusion == "yes", "Included", "Excluded")
  ) %>%
  select(label, Natal, Dichromatism, Dimorphism, Dataset, Included)

# Set rownames = species label
heatmap_matrix <- heatmap_data %>%
  column_to_rownames("label")

# ──────────────────────────────────────────────────────────
# 2 · super-family order + tip order
# ──────────────────────────────────────────────────────────
superfamily_map <- list(
  Lemuroidea       = c("Lemuridae", "Indriidae", "Lepilemuridae", "Cheirogaleidae"),
  Daubentonioidea  = "Daubentoniidae",
  Lorisoidea       = c("Lorisidae", "Galagidae"),
  Tarsioidea       = "Tarsiidae",
  Ceboidea         = c("Callitrichidae","Cebidae","Atelidae","Aotidae","Pitheciidae"),
  Cercopithecoidea = "Cercopithecidae",
  Hominoidea       = c("Hylobatidae","Hominidae")
)

tip_data$superfamily <- NA_character_
for (sf in names(superfamily_map))
  tip_data$superfamily[tip_data$family %in% superfamily_map[[sf]]] <- sf

sf_order <- c("Lemuroidea","Daubentonioidea","Lorisoidea",
              "Tarsioidea","Ceboidea","Cercopithecoidea","Hominoidea")

ordered_tips <- unlist(lapply(sf_order, function(sf) {
  tip_data %>%
    filter(superfamily == sf) %>%
    arrange(family, tree_species) %>%
    pull(label)
}))
ordered_tips <- c(ordered_tips, setdiff(tree$tip.label, ordered_tips))  # guarantee full set

# ──────────────────────────────────────────────────────────
# 3 · highlight data and node label data (only for Tree panel!)
# ──────────────────────────────────────────────────────────
highlight_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (!length(tl)) return(NULL)
  tibble(
    node        = if (length(tl)==1) which(tree$tip.label==tl) else MRCA(tree, tl),
    superfamily = sf,
    .panel      = "Tree"  # This restricts highlights to Tree panel only!
  )
}) %>%
  mutate(superfamily = factor(superfamily, levels = rev(sf_order)))

# Create node label data for superfamilies
tree_fortified <- fortify(tree)
node_label_data <- map_dfr(sf_order, function(sf) {
  tl <- tip_data$label[tip_data$superfamily == sf]
  if (length(tl) <= 1) return(NULL)  # Only label groups with multiple species
  mrca_node <- MRCA(tree, tl)
  node_info <- tree_fortified[tree_fortified$node == mrca_node, ]
  if (nrow(node_info) == 0) return(NULL)
  tibble(
    x = node_info$x,
    y = node_info$y,
    label = sf,
    .panel = "Tree"
  )
})

max_tip_x <- max(node.depth.edgelength(tree)[seq_along(tree$tip.label)])

# ──────────────────────────────────────────────────────────
# 4 · BUILD BASE TREE PANEL
# ──────────────────────────────────────────────────────────
p_tree_base <- ggtree(tree,
                      layout    = "rectangular", 
                      # tip_order = ordered_tips,
                      size      = .3,
                      root.position = 1) +
  geom_hilight(
    data     = highlight_data,
    aes(node = node, fill = superfamily),
    alpha    = .30,
    extendto = max_tip_x - 0.02
  ) +
  geom_tiplab(size = 1, align = TRUE, linesize = .1, offset = 0.02) +
  geom_text(
    data = node_label_data,
    aes(x = x, y = y, label = label),
    size = 3,
    fontface = "bold",
    hjust = 1.1,
    inherit.aes = FALSE
  ) +
  scale_fill_viridis_d(
    option    = "viridis",
    begin     = 0,
    end       = .95,
    direction = -1,
    guide     = "none"
  ) +
  theme_tree2() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x  = element_blank()
  )

# Add hexpand to tree
p_tree_expanded <- p_tree_base + hexpand(.6, direction = 1)

# ──────────────────────────────────────────────────────────
# 5 · SINGLE DATASET PANEL (replace old Traits / Dataset / Included blocks)
# ──────────────────────────────────────────────────────────
p_with_dataset <- p_tree_expanded + new_scale_fill()

dataset_long <- tip_data %>%
  select(label, type_dataset, inclusion) %>%
  mutate(x = 1,
         fill = if_else(inclusion == "yes", type_dataset, "Excluded"))

p_with_dataset <- p_with_dataset +
  geom_facet(
    panel   = "Dataset",
    data    = dataset_long,
    geom    = geom_tile,
    mapping = aes(x = x, fill = fill),
    width   = 1
  ) +
  # scale_x_continuous(
  #   breaks = 1, limits = c(0.5, 1), expand = c(0, 0), labels = "Dataset"
  # ) +
  scale_fill_manual(
  name   = "Dataset",
  values = c(dataset_cols, Excluded = "white"),
  breaks = c("focal", "gibbon", "additional")
  ) +
  theme(
    axis.text.x = element_text(size = 6, angle = 90, vjust = 0.5, hjust = 1),
    axis.title.x = element_blank(), axis.ticks.x = element_blank(),
    axis.line.x  = element_blank()
  )

# ──────────────────────────────────────────────────────────
# 6 · PHOTO PANEL (build off p_with_dataset, not p_with_included)
# ──────────────────────────────────────────────────────────
p_reset_scale <- p_with_dataset + scale_x_ggtree()   # <-- key change

# ──────────────────────────────────────────────────────────
# 6 · ADD PHOTO PANEL (with vline at 100)
# ──────────────────────────────────────────────────────────
p_with_photo <- p_reset_scale + new_scale_fill()

photo_long <- tip_data %>%
  transmute(
    label,
    iNaturalist = replace_na(inat_total_photos, 0),
    GBIF_obs    = replace_na(gbif_photos,       0)
  ) %>%
  pivot_longer(-label, names_to = "source", values_to = "count") %>%
  filter(count > 0)  # Remove zeros for log scale

# Data for vertical line at 100
vline_data <- data.frame(
  x = 100,
  .panel = "Photo counts"
)

p_with_photo <- facet_plot(
        p_with_photo,
        panel   = "Photo counts",
        data    = photo_long,
        geom    = geom_col,
        mapping = aes(x = count, fill = source),
        orientation = "y",
        width   = 0.6,
        scales  = "free_x"
     )

# # Add vertical line at 100
# p_with_photo <- p_with_photo +
#   geom_vline(
#     data = vline_data,
#     aes(xintercept = x),
#     linetype = "dashed",
#     color = "gray50",
#     size = 0.5
#   )

# Apply log scale and theme
p_with_photo <- p_with_photo +
     scale_x_log10(
       name   = "Photo count (log10)",
       breaks = c(1, 10, 100, 1000, 10000, 100000, 1000000),
       labels = c("1", "10", "100", "1k", "10k", "100k", "1M"),
       expand = c(0, 0)
     ) +
  scale_fill_manual(
  name   = "Source",
  values = photo_cols,
  labels = c(iNaturalist = "iNaturalist", GBIF_obs = "GBIF")
  ) +
     theme(
       axis.text.x  = element_text(size = 6),
       axis.title.x = element_text(size = 7, face = "bold"),
       axis.ticks.x = element_blank(),
       axis.line.x  = element_blank()
     )

# ──────────────────────────────────────────────────────────
# 7 · FINALIZE: Add legend formatting
# ──────────────────────────────────────────────────────────
library(grid)

p_final <- p_with_photo +
  guides(
    Traits = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 1),
    Source = guide_legend(keywidth = .3, keyheight = .5,
                          default.unit = "cm", order = 2)
  ) +
  theme(
    legend.key.size  = unit(.35, "cm"),
    legend.spacing.y = unit(.1,  "cm")
  )

# ──────────────────────────────────────────────────────────
# 8 · Set facet widths
# ──────────────────────────────────────────────────────────
p_final <- facet_widths(
        p_final,
        c(Tree = 2,
          Dataset = 0.5,
          `Photo counts` = 1.0)
     )

# Apply final theme
p_final <- p_final +
  theme(
    axis.text.x.top     = element_blank(),
    axis.ticks.x.top    = element_blank(),
    axis.title.x.top    = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.title.x.bottom = element_blank(),
    legend.text  = element_text(size = 7),
    legend.title = element_text(size = 8, face = "bold"),
    panel.spacing.x = unit(0, "cm"),
    plot.margin  = margin(10, 10, 10, 10)
  )

# ──────────────────────────────────────────────────────────
# 9 · Export
# ──────────────────────────────────────────────────────────
ggsave("output/primate_phylogeny_datasets.pdf", p_final, width = 11, height = 15, units = "in")
ggsave("output/primate_phylogeny_datasets.png", p_final, width = 11, height = 15, units = "in", dpi = 500)

print(p_final)
```
